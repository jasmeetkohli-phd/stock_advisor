# stock_risk_advisor_enhanced.py
# Enhanced Stock Investment Risk Assessment App with comprehensive improvements
# Fixes: UI tooltips, financial logic, CSV bugs, age mapping, validation, transparency

import os
import json
import csv
import io
from datetime import datetime
from typing import Dict, List, Optional, Any, Tuple
import numpy as np
import pandas as pd
import streamlit as st
import plotly.graph_objects as go
import plotly.express as px

# Try to import ReportLab for PDF generation
try:
    from reportlab.pdfgen import canvas
    from reportlab.lib.pagesizes import letter
    from reportlab.lib import colors
    REPORTLAB_AVAILABLE = True
except ImportError:
    REPORTLAB_AVAILABLE = False

# ============================================================================
# CONFIGURATION & CONSTANTS
# ============================================================================

APP_TITLE = "ðŸ“ˆ Stock Risk Advisor"
APP_ICON = "ðŸ“Š"
MODEL_VERSION = "2.1"
MINIMUM_INVESTMENT_THRESHOLD = 500  # rupees
CSV_FILE = "assessments_data_v2.csv"

# Updated mapping dictionaries (more realistic Indian ranges)
INCOME_MAP = {
    1: 20000,   # < â‚¹25,000 (average 20k)
    2: 37500,   # â‚¹25,001 â€“ â‚¹50,000 (average 37.5k)
    3: 62500,   # â‚¹50,001 â€“ â‚¹75,000 (average 62.5k)
    4: 87500,   # â‚¹75,001 â€“ â‚¹1,00,000
    5: 125000,  # â‚¹1,00,001 â€“ â‚¹1,50,000
    6: 200000   # Above â‚¹1,50,000
}

EXPENSES_MAP = {
    1: 15000,   # Less than â‚¹20,000
    2: 27500,   # â‚¹20,001 â€“ â‚¹35,000
    3: 42500,   # â‚¹35,001 â€“ â‚¹50,000
    4: 62500,   # â‚¹50,001 â€“ â‚¹75,000
    5: 87500,   # â‚¹75,001 â€“ â‚¹1,00,000
    6: 125000   # Above â‚¹1,00,000
}

EMERGENCY_MAP = {
    1: 0,    # No emergency savings
    2: 0.5,  # Less than 1 month
    3: 2,    # 1â€“3 months
    4: 5,    # 4â€“6 months (Recommended)
    5: 9.5,  # 7â€“12 months
    6: 15    # More than 12 months
}

# FIXED: Correct age-equity mapping (younger = more equity)
AGE_EQUITY_MAP = {
    1: 85,   # Under 25 years (higher equity allocation)
    2: 75,   # 25-34 years
    3: 65,   # 35-44 years
    4: 55,   # 45-54 years
    5: 40,   # 55-64 years
    6: 30    # 65+ years (lower equity allocation)
}

TIMEFRAME_MAP = {
    1: 1,   # Less than 2 years
    2: 3,   # 2â€“4 years
    3: 6,   # 5â€“7 years
    4: 10,  # 8â€“12 years
    5: 15,  # 13+ years
    6: 10   # Multiple timeframes (conservative)
}

LOSS_TOLERANCE_MAP = {
    1: 2.5,   # 0â€“5%
    2: 10.5,  # 6â€“15%
    3: 20.5,  # 16â€“25%
    4: 30.5,  # 26â€“35%
    5: 43,    # 36â€“50%
    6: 60     # More than 50%
}

# Updated scoring weights (fixed double counting)
WEIGHTS = {
    "financial_stability": 0.30,
    "risk_tolerance": 0.30,
    "investment_horizon": 0.20,
    "knowledge_experience": 0.20
}

# Stock database with enhanced categorization
STOCKS_DB = {
    "Large_Cap": [
        {"symbol": "RELIANCE", "name": "Reliance Industries", "sector": "Energy", 
         "risk": "Low", "note": "Market leader, diversified"},
        {"symbol": "TCS", "name": "Tata Consultancy Services", "sector": "IT", 
         "risk": "Low", "note": "IT services giant, stable"},
        {"symbol": "HDFCBANK", "name": "HDFC Bank", "sector": "Banking", 
         "risk": "Low", "note": "Premier private bank"},
        {"symbol": "INFY", "name": "Infosys", "sector": "IT", 
         "risk": "Low", "note": "Global IT consulting"},
        {"symbol": "ICICIBANK", "name": "ICICI Bank", "sector": "Banking", 
         "risk": "Low-Medium", "note": "Diversified banking services"}
    ],
    "Mid_Cap": [
        {"symbol": "TITAN", "name": "Titan Company", "sector": "Consumer", 
         "risk": "Medium", "note": "Lifestyle brand leader"},
        {"symbol": "MARUTI", "name": "Maruti Suzuki", "sector": "Auto", 
         "risk": "Medium", "note": "India's largest carmaker"},
        {"symbol": "ASIANPAINT", "name": "Asian Paints", "sector": "Paints", 
         "risk": "Medium", "note": "Paint industry leader"},
        {"symbol": "BAJFINANCE", "name": "Bajaj Finance", "sector": "Financial", 
         "risk": "Medium-High", "note": "Consumer financing leader"}
    ],
    "Small_Cap": [
        {"symbol": "TATAELXSI", "name": "Tata Elxsi", "sector": "IT", 
         "risk": "High", "note": "Design & technology services"},
        {"symbol": "COFORGE", "name": "Coforge", "sector": "IT", 
         "risk": "High", "note": "Digital IT solutions"},
        {"symbol": "LAURUSLABS", "name": "Laurus Labs", "sector": "Pharma", 
         "risk": "High", "note": "Pharmaceuticals & APIs"}
    ],
    "Growth": [
        {"symbol": "DMART", "name": "Avenue Supermarts", "sector": "Retail", 
         "risk": "Medium-High", "note": "Value retail chain"},
        {"symbol": "BAJAJFINSV", "name": "Bajaj Finserv", "sector": "Financial", 
         "risk": "Medium-High", "note": "Diversified financial services"},
        {"symbol": "TECHM", "name": "Tech Mahindra", "sector": "IT", 
         "risk": "Medium", "note": "Digital transformation services"}
    ]
}

# ETF recommendations for different risk profiles
ETFS_DB = {
    "VERY LOW RISK": ["NIFTYBEES", "BANKBEES", "GOLDBEES"],
    "LOW RISK": ["NIFTYBEES", "MIDCAPBEES"],
    "MEDIUM RISK": ["NIFTYBEES", "MIDCAPBEES"],
    "HIGH RISK": ["MIDCAPBEES", "SMLCAPBEES"],
    "VERY HIGH RISK": ["SMLCAPBEES"]
}

# ============================================================================
# CORE CLASSES
# ============================================================================

class RiskCalculator:
    """Enhanced calculator with fixed logic and transparency"""
    
    @staticmethod
    def map_to_score(value: int, min_val: int = 1, max_val: int = 6, reverse: bool = False) -> float:
        """Map 1-6 scale to 0-100 score"""
        if reverse:
            value = max_val - value + min_val
        return ((value - min_val) / (max_val - min_val)) * 100
    
    @staticmethod
    def validate_answers(answers: Dict[str, int]) -> Tuple[bool, List[str]]:
        """Validate answers for consistency and logic"""
        warnings = []
        
        # Check all questions answered
        for i in range(1, 15):
            if f'q{i}' not in answers or answers[f'q{i}'] is None:
                return False, [f"Question {i} not answered"]
        
        # Validate income vs expenses (realistic check)
        q1 = answers.get('q1', 3)
        q2 = answers.get('q2', 3)
        
        income_val = INCOME_MAP.get(q1, 0)
        expense_val = EXPENSES_MAP.get(q2, 0)
        
        if expense_val > income_val * 0.95:  # 95% threshold
            warnings.append("Your expenses seem very high relative to income. Please review if accurate.")
        
        # Check emergency fund vs timeframe mismatch
        q3 = answers.get('q3', 3)
        q6 = answers.get('q6', 3)
        
        if q3 <= 2 and q6 <= 2:  # Low emergency fund + short timeframe
            warnings.append("Low emergency fund with short investment timeframe may be risky")
        
        return True, warnings
    
    @staticmethod
    def calculate_financial_score(answers: Dict[str, int]) -> Dict[str, float]:
        """Calculate Financial Health Score (0-100) based on Q1-Q4"""
        monthly_income = INCOME_MAP.get(answers.get('q1', 3), 62500)
        monthly_expenses = EXPENSES_MAP.get(answers.get('q2', 3), 42500)
        emergency_score = answers.get('q3', 3)
        debt_score = answers.get('q4', 3)
        
        # Emergency Fund Component (0-100)
        emergency_component = RiskCalculator.map_to_score(emergency_score)
        
        # Debt Component (reverse scale: less debt = higher score)
        debt_component = RiskCalculator.map_to_score(debt_score, reverse=True)
        
        # Savings Rate Component
        if monthly_income > 0:
            savings_rate = (monthly_income - monthly_expenses) / monthly_income
            
            if savings_rate <= 0:
                savings_rate_component = 0
            elif savings_rate >= 0.3:  # 30% savings rate = excellent
                savings_rate_component = 100
            else:
                # Linear scale: 0% savings = 0, 30% savings = 100
                savings_rate_component = (savings_rate / 0.3) * 100
        else:
            savings_rate_component = 0
        
        # Calculate final financial score (weighted average)
        financial_score = (
            0.40 * emergency_component +      # Emergency fund is most important
            0.35 * debt_component +          # Debt situation second
            0.25 * savings_rate_component    # Savings rate third
        )
        
        # Calculate supporting metrics
        disposable_income = max(0, monthly_income - monthly_expenses)
        savings_rate_pct = (disposable_income / monthly_income * 100) if monthly_income > 0 else 0
        
        return {
            'financial_score': round(financial_score, 2),
            'emergency_component': round(emergency_component, 2),
            'debt_component': round(debt_component, 2),
            'savings_component': round(savings_rate_component, 2),
            'disposable_income': round(disposable_income, 2),
            'savings_rate': round(savings_rate_pct, 2),
            'monthly_income': monthly_income,
            'monthly_expenses': monthly_expenses,
            'emergency_months': EMERGENCY_MAP.get(emergency_score, 2)
        }
    
    @staticmethod
    def calculate_risk_tolerance(answers: Dict[str, int]) -> Dict[str, float]:
        """Calculate Risk Tolerance Score from psychology questions (Q7-Q10)"""
        scores = {
            'loss_importance': answers.get('q7', 3),  # Q7: Avoiding loss importance
            'emotional': answers.get('q8', 3),        # Q8: Reaction to drop
            'loss_tolerance': answers.get('q9', 3),   # Q9: Max tolerable loss
            'volatility_view': answers.get('q10', 3)  # Q10: View on volatility
        }
        
        # Convert to 0-100 scale with appropriate direction
        components = {
            'loss_importance': RiskCalculator.map_to_score(scores['loss_importance'], reverse=True),
            'emotional': RiskCalculator.map_to_score(scores['emotional']),
            'loss_tolerance': RiskCalculator.map_to_score(scores['loss_tolerance']),
            'volatility_view': RiskCalculator.map_to_score(scores['volatility_view'])
        }
        
        # Weighted risk tolerance score
        risk_tolerance_score = (
            0.30 * components['loss_importance'] +  # How important is avoiding loss
            0.25 * components['emotional'] +        # Emotional reaction
            0.30 * components['loss_tolerance'] +   # Actual loss tolerance
            0.15 * components['volatility_view']    # View on volatility
        )
        
        return {
            'risk_tolerance_score': round(risk_tolerance_score, 2),
            'components': components,
            'max_tolerable_loss_pct': LOSS_TOLERANCE_MAP.get(scores['loss_tolerance'], 20.5)
        }
    
    @staticmethod
    def calculate_horizon_score(answers: Dict[str, int]) -> Dict[str, float]:
        """Calculate Investment Horizon Score (Q5, Q6, Q13)"""
        scores = {
            'goal': answers.get('q5', 4),      # Q5: Investment goal
            'timeframe': answers.get('q6', 3),  # Q6: Timeframe
            'liquidity': answers.get('q13', 4)  # Q13: Liquidity needs
        }
        
        # Convert to 0-100 scale
        components = {
            'goal': RiskCalculator.map_to_score(scores['goal']),
            'timeframe': RiskCalculator.map_to_score(scores['timeframe']),
            'liquidity': RiskCalculator.map_to_score(scores['liquidity'], reverse=True)
        }
        
        # Weighted horizon score
        horizon_score = (
            0.40 * components['goal'] +      # Goal importance
            0.40 * components['timeframe'] + # Timeframe length
            0.20 * components['liquidity']   # Liquidity needs (reverse)
        )
        
        return {
            'horizon_score': round(horizon_score, 2),
            'components': components,
            'timeframe_years': TIMEFRAME_MAP.get(scores['timeframe'], 6)
        }
    
    @staticmethod
    def calculate_knowledge_score(answers: Dict[str, int]) -> Dict[str, float]:
        """Calculate Knowledge & Experience Score (Q11, Q12)"""
        scores = {
            'experience': answers.get('q11', 2),  # Q11: Experience
            'knowledge': answers.get('q12', 2)    # Q12: Knowledge
        }
        
        # Convert to 0-100 scale
        components = {
            'experience': RiskCalculator.map_to_score(scores['experience']),
            'knowledge': RiskCalculator.map_to_score(scores['knowledge'])
        }
        
        # Weighted knowledge score
        knowledge_score = (
            0.60 * components['experience'] +  # Experience weighted more
            0.40 * components['knowledge']     # Knowledge weighted less
        )
        
        return {
            'knowledge_score': round(knowledge_score, 2),
            'components': components
        }
    
    @staticmethod
    def calculate_overall_risk_score(answers: Dict[str, int]) -> Dict[str, Any]:
        """Calculate Overall Risk Score using fixed weights (no double counting)"""
        # Calculate individual components
        financial_data = RiskCalculator.calculate_financial_score(answers)
        risk_tolerance_data = RiskCalculator.calculate_risk_tolerance(answers)
        horizon_data = RiskCalculator.calculate_horizon_score(answers)
        knowledge_data = RiskCalculator.calculate_knowledge_score(answers)
        
        # Weighted overall score (using FIXED weights)
        overall_score = (
            WEIGHTS['financial_stability'] * financial_data['financial_score'] +
            WEIGHTS['risk_tolerance'] * risk_tolerance_data['risk_tolerance_score'] +
            WEIGHTS['investment_horizon'] * horizon_data['horizon_score'] +
            WEIGHTS['knowledge_experience'] * knowledge_data['knowledge_score']
        )
        
        return {
            'overall_risk_score': round(overall_score, 2),
            'financial_data': financial_data,
            'risk_tolerance_data': risk_tolerance_data,
            'horizon_data': horizon_data,
            'knowledge_data': knowledge_data,
            'weights_used': WEIGHTS,
            'model_version': MODEL_VERSION
        }
    
    @staticmethod
    def get_risk_category(overall_risk_score: float) -> str:
        """Determine risk category based on score"""
        if overall_risk_score <= 20:
            return "VERY LOW RISK"
        elif overall_risk_score <= 40:
            return "LOW RISK"
        elif overall_risk_score <= 60:
            return "MEDIUM RISK"
        elif overall_risk_score <= 80:
            return "HIGH RISK"
        else:
            return "VERY HIGH RISK"
    
    @staticmethod
    def check_investment_suitability(answers: Dict[str, int], financial_data: Dict[str, float]) -> Dict[str, Any]:
        """Check if user should invest in stocks at all"""
        emergency_score = answers.get('q3', 3)
        debt_score = answers.get('q4', 3)
        liquidity_score = answers.get('q13', 4)
        
        warnings = []
        blocking_issues = []
        
        # CRITICAL ISSUES (block investment)
        if emergency_score <= 1:  # No emergency savings
            blocking_issues.append("No emergency savings")
        
        if debt_score >= 5:  # Significant debt stress
            blocking_issues.append("Significant debt stress")
        
        if liquidity_score <= 1:  # Very likely to need money soon
            blocking_issues.append("Very likely to need money within 1 year")
        
        # WARNINGS (caution advised)
        if emergency_score <= 2:  # Less than 1 month
            warnings.append("Emergency fund less than 1 month")
        
        if debt_score >= 4:  # High-interest debt concerns
            warnings.append("High-interest debt concerns")
        
        if liquidity_score <= 2:  # Likely to need money in 1-2 years
            warnings.append("May need money within 1-2 years")
        
        # Determine suitability
        if blocking_issues:
            suitability = "NOT SUITABLE"
            recommendation = "Focus on building emergency fund and reducing debt before investing in stocks"
        elif warnings:
            suitability = "CAUTION ADVISED"
            recommendation = "Consider addressing warnings before significant stock investment"
        else:
            suitability = "SUITABLE"
            recommendation = "Proceed with recommended investment plan"
        
        return {
            'suitability': suitability,
            'blocking_issues': blocking_issues,
            'warnings': warnings,
            'recommendation': recommendation
        }
    
    @staticmethod
    def determine_portfolio_allocation(overall_risk_score: float, answers: Dict[str, int]) -> Dict[str, float]:
        """Determine portfolio allocation with fixed age logic"""
        # Get age-adjusted equity percentage
        age_score = answers.get('q14', 4)
        base_equity_pct = AGE_EQUITY_MAP.get(age_score, 65)  # FIXED: younger = more equity
        
        # Risk adjustment to base equity
        risk_multiplier = overall_risk_score / 100  # 0 to 1
        
        # Adjusted equity percentage
        adjusted_equity_pct = base_equity_pct * (0.7 + 0.3 * risk_multiplier)
        
        # Distribute equity across categories based on risk
        if overall_risk_score <= 20:  # VERY LOW RISK
            allocation = {
                "Large_Cap": adjusted_equity_pct,
                "Mid_Cap": 0,
                "Small_Cap": 0,
                "Growth": 0,
                "Fixed_Income": 100 - adjusted_equity_pct
            }
        elif overall_risk_score <= 40:  # LOW RISK
            allocation = {
                "Large_Cap": adjusted_equity_pct * 0.8,
                "Mid_Cap": adjusted_equity_pct * 0.2,
                "Small_Cap": 0,
                "Growth": 0,
                "Fixed_Income": 100 - adjusted_equity_pct
            }
        elif overall_risk_score <= 60:  # MEDIUM RISK
            allocation = {
                "Large_Cap": adjusted_equity_pct * 0.6,
                "Mid_Cap": adjusted_equity_pct * 0.3,
                "Small_Cap": adjusted_equity_pct * 0.05,
                "Growth": adjusted_equity_pct * 0.05,
                "Fixed_Income": 100 - adjusted_equity_pct
            }
        elif overall_risk_score <= 80:  # HIGH RISK
            allocation = {
                "Large_Cap": adjusted_equity_pct * 0.4,
                "Mid_Cap": adjusted_equity_pct * 0.3,
                "Small_Cap": adjusted_equity_pct * 0.15,
                "Growth": adjusted_equity_pct * 0.15,
                "Fixed_Income": 100 - adjusted_equity_pct
            }
        else:  # VERY HIGH RISK
            allocation = {
                "Large_Cap": adjusted_equity_pct * 0.2,
                "Mid_Cap": adjusted_equity_pct * 0.25,
                "Small_Cap": adjusted_equity_pct * 0.25,
                "Growth": adjusted_equity_pct * 0.3,
                "Fixed_Income": 100 - adjusted_equity_pct
            }
        
        # Normalize to ensure exact 100%
        total = sum(allocation.values())
        if abs(total - 100) > 0.01:
            allocation = {k: (v / total) * 100 for k, v in allocation.items()}
        
        # Round to 1 decimal
        allocation = {k: round(v, 1) for k, v in allocation.items()}
        
        # Ensure exact 100% after rounding
        rounded_sum = sum(allocation.values())
        if abs(rounded_sum - 100) > 0:
            # Adjust largest category
            largest_key = max(allocation, key=allocation.get)
            allocation[largest_key] = round(allocation[largest_key] + (100 - rounded_sum), 1)
        
        return allocation
    
    @staticmethod
    def calculate_safe_investment(answers: Dict[str, int], financial_data: Dict[str, float], 
                                 risk_data: Dict[str, Any]) -> Dict[str, float]:
        """Calculate safe monthly investment amount with enhanced logic"""
        monthly_income = financial_data.get('monthly_income', 0)
        monthly_expenses = financial_data.get('monthly_expenses', 0)
        disposable_income = financial_data.get('disposable_income', 0)
        financial_score = financial_data.get('financial_score', 0)
        emergency_months = financial_data.get('emergency_months', 2)
        
        # Get suitability check
        suitability = RiskCalculator.check_investment_suitability(answers, financial_data)
        
        # If not suitable, investment should be minimal or zero
        if suitability['suitability'] == "NOT SUITABLE":
            return {
                'safe_monthly_investment': 0,
                'annual_investment': 0,
                'monthly_ef_saving': disposable_income * 0.5,
                'monthly_debt_payment': disposable_income * 0.3,
                'ef_gap_amount': max(0, 6 - emergency_months) * monthly_expenses,
                'investment_percentage': 0,
                'investment_confidence': "Very Low",
                'suitability': suitability,
                'recommendation_priority': "EMERGENCY_FUND_DEBT"
            }
        
        # Calculate emergency fund gap
        target_emergency_months = 6  # Recommended minimum
        ef_gap_months = max(0, target_emergency_months - emergency_months)
        ef_gap_amount = ef_gap_months * monthly_expenses
        
        # Debt priority
        debt_score = answers.get('q4', 3)
        debt_priority_amount = 0
        if debt_score >= 4:  # High-interest debt concerns
            debt_priority_percentage = 0.15 + (debt_score - 4) * 0.05
            debt_priority_amount = disposable_income * debt_priority_percentage
        
        # Financial health multiplier
        if financial_score < 40:
            fh_multiplier = 0.0
        elif financial_score < 60:
            fh_multiplier = 0.15
        elif financial_score < 80:
            fh_multiplier = 0.25
        else:
            fh_multiplier = 0.35
        
        # Risk tolerance multiplier
        risk_tolerance = risk_data.get('risk_tolerance_data', {}).get('risk_tolerance_score', 50)
        risk_multiplier = risk_tolerance / 100
        
        # Timeframe multiplier
        timeframe_score = answers.get('q6', 3)
        timeframe_multiplier = min(1.0, TIMEFRAME_MAP.get(timeframe_score, 6) / 10)
        
        # Combined investment percentage
        base_percentage = fh_multiplier * (0.5 + 0.5 * risk_multiplier)
        investment_percentage = base_percentage * timeframe_multiplier
        
        # Calculate available after priorities
        available_after_priorities = max(0, disposable_income - debt_priority_amount)
        
        # Emergency fund building
        monthly_ef_saving = 0
        if ef_gap_amount > 0 and disposable_income > 0:
            build_timeline = min(18, max(6, int(ef_gap_months * 3)))
            monthly_ef_saving = min(available_after_priorities * 0.5, ef_gap_amount / build_timeline)
            available_for_investment = max(0, available_after_priorities - monthly_ef_saving)
        else:
            available_for_investment = available_after_priorities
        
        # Calculate safe investment
        safe_monthly_investment = min(
            available_for_investment * investment_percentage,
            available_for_investment * 0.3  # Cap at 30% of available
        )
        
        # Apply minimum threshold
        if safe_monthly_investment < MINIMUM_INVESTMENT_THRESHOLD:
            safe_monthly_investment = 0
        
        # Determine confidence
        if safe_monthly_investment == 0:
            confidence = "Very Low"
        elif safe_monthly_investment < disposable_income * 0.05:
            confidence = "Low"
        elif safe_monthly_investment < disposable_income * 0.10:
            confidence = "Medium"
        elif safe_monthly_investment < disposable_income * 0.20:
            confidence = "High"
        else:
            confidence = "Very High"
        
        # Determine priority
        if ef_gap_amount > 0 and emergency_months < 3:
            priority = "EMERGENCY_FUND"
        elif debt_priority_amount > 0:
            priority = "DEBT_REDUCTION"
        else:
            priority = "INVESTMENT"
        
        return {
            'safe_monthly_investment': round(safe_monthly_investment, 2),
            'annual_investment': round(safe_monthly_investment * 12, 2),
            'monthly_ef_saving': round(monthly_ef_saving, 2),
            'monthly_debt_payment': round(debt_priority_amount, 2),
            'ef_gap_amount': round(ef_gap_amount, 2),
            'ef_build_timeline': 12 if ef_gap_amount > 0 else 0,
            'investment_percentage': round(investment_percentage * 100, 2),
            'investment_confidence': confidence,
            'available_for_investment': round(available_for_investment, 2),
            'suitability': suitability,
            'recommendation_priority': priority
        }
    
    @staticmethod
    def get_stock_recommendations(risk_category: str, allocation: Dict[str, float]) -> Dict[str, Any]:
        """Get stock recommendations based on risk category"""
        recommendations = {
            "VERY LOW RISK": {
                "strategy": "Conservative Income",
                "description": "Focus on stability and regular income",
                "stocks": STOCKS_DB["Large_Cap"][:3],
                "etfs": ETFS_DB.get("VERY LOW RISK", []),
                "allocation_notes": "Primarily large-cap stocks for stability"
            },
            "LOW RISK": {
                "strategy": "Balanced Growth",
                "description": "Mix of stability and moderate growth",
                "stocks": STOCKS_DB["Large_Cap"][:4] + STOCKS_DB["Mid_Cap"][:1],
                "etfs": ETFS_DB.get("LOW RISK", []),
                "allocation_notes": "Mostly large-cap with some mid-cap exposure"
            },
            "MEDIUM RISK": {
                "strategy": "Growth Oriented",
                "description": "Balance of growth and reasonable risk",
                "stocks": STOCKS_DB["Large_Cap"][:3] + STOCKS_DB["Mid_Cap"][:2] + STOCKS_DB["Growth"][:1],
                "etfs": ETFS_DB.get("MEDIUM RISK", []),
                "allocation_notes": "Diversified across market caps"
            },
            "HIGH RISK": {
                "strategy": "Aggressive Growth",
                "description": "Focus on growth with higher risk tolerance",
                "stocks": STOCKS_DB["Large_Cap"][:2] + STOCKS_DB["Mid_Cap"][:2] + 
                         STOCKS_DB["Small_Cap"][:1] + STOCKS_DB["Growth"][:2],
                "etfs": ETFS_DB.get("HIGH RISK", []),
                "allocation_notes": "Significant mid/small cap and growth exposure"
            },
            "VERY HIGH RISK": {
                "strategy": "Speculative Growth",
                "description": "High-risk, high-potential investments",
                "stocks": STOCKS_DB["Mid_Cap"][:2] + STOCKS_DB["Small_Cap"][:2] + STOCKS_DB["Growth"][:2],
                "etfs": ETFS_DB.get("VERY HIGH RISK", []),
                "allocation_notes": "Heavy emphasis on growth and small caps"
            }
        }
        
        base_rec = recommendations.get(risk_category, recommendations["MEDIUM RISK"])
        
        # Filter stocks based on actual allocation
        filtered_stocks = []
        for stock in base_rec["stocks"]:
            # Simple mapping of stock to category
            if stock in STOCKS_DB["Large_Cap"] and allocation.get("Large_Cap", 0) > 0:
                filtered_stocks.append(stock)
            elif stock in STOCKS_DB["Mid_Cap"] and allocation.get("Mid_Cap", 0) > 0:
                filtered_stocks.append(stock)
            elif stock in STOCKS_DB["Small_Cap"] and allocation.get("Small_Cap", 0) > 0:
                filtered_stocks.append(stock)
            elif stock in STOCKS_DB["Growth"] and allocation.get("Growth", 0) > 0:
                filtered_stocks.append(stock)
        
        # Limit to top 5-6 stocks
        filtered_stocks = filtered_stocks[:6]
        
        return {
            **base_rec,
            "stocks": filtered_stocks
        }


class CSVDataHandler:
    """Handles CSV data operations with enhanced error handling and proper storage"""
    
    @staticmethod
    def save_assessment_to_csv(assessment_data: Dict[str, Any]) -> bool:
        """Save assessment data to CSV with proper value storage"""
        try:
            answers = assessment_data.get('answers', {})
            financial_data = assessment_data.get('financial_data', {})
            risk_data = assessment_data.get('risk_data', {})
            investment_data = assessment_data.get('investment_data', {})
            allocation = assessment_data.get('allocation', {})
            risk_category = assessment_data.get('risk_category', 'Unknown')
            
            # Get actual values from maps (CRITICAL FIX)
            income_code = answers.get('q1', 3)
            expense_code = answers.get('q2', 3)
            
            row = {
                'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                'model_version': MODEL_VERSION,
                
                # Store BOTH code and actual value (CRITICAL)
                'income_code': int(income_code),
                'income_value': int(INCOME_MAP.get(income_code, 62500)),
                'expense_code': int(expense_code),
                'expense_value': int(EXPENSES_MAP.get(expense_code, 42500)),
                
                # Other answers
                'emergency_fund': int(answers.get('q3', 3)),
                'debt_situation': int(answers.get('q4', 3)),
                'primary_goal': int(answers.get('q5', 4)),
                'timeframe': int(answers.get('q6', 3)),
                'loss_importance': int(answers.get('q7', 3)),
                'emotional_reaction': int(answers.get('q8', 3)),
                'loss_tolerance': int(answers.get('q9', 3)),
                'volatility_view': int(answers.get('q10', 3)),
                'experience': int(answers.get('q11', 2)),
                'knowledge': int(answers.get('q12', 2)),
                'liquidity_needs': int(answers.get('q13', 4)),
                'age_group': int(answers.get('q14', 4)),
                
                # Scores
                'financial_health_score': float(financial_data.get('financial_score', 0)),
                'risk_tolerance_score': float(risk_data.get('risk_tolerance_data', {}).get('risk_tolerance_score', 0)),
                'horizon_score': float(risk_data.get('horizon_data', {}).get('horizon_score', 0)),
                'knowledge_score': float(risk_data.get('knowledge_data', {}).get('knowledge_score', 0)),
                'overall_risk_score': float(risk_data.get('overall_risk_score', 0)),
                
                # Risk category
                'risk_category': str(risk_category),
                
                # Investment recommendations
                'monthly_investment': float(investment_data.get('safe_monthly_investment', 0)),
                'annual_investment': float(investment_data.get('annual_investment', 0)),
                'investment_confidence': str(investment_data.get('investment_confidence', 'Low')),
                'suitability': str(investment_data.get('suitability', {}).get('suitability', 'Unknown')),
                
                # Portfolio allocation
                'portfolio_large_cap': float(allocation.get('Large_Cap', 0)),
                'portfolio_mid_cap': float(allocation.get('Mid_Cap', 0)),
                'portfolio_small_cap': float(allocation.get('Small_Cap', 0)),
                'portfolio_growth': float(allocation.get('Growth', 0)),
                'portfolio_fixed_income': float(allocation.get('Fixed_Income', 0))
            }
            
            file_exists = os.path.isfile(CSV_FILE)
            
            with open(CSV_FILE, 'a', newline='', encoding='utf-8') as f:
                writer = csv.DictWriter(f, fieldnames=row.keys())
                if not file_exists:
                    writer.writeheader()
                writer.writerow(row)
            
            return True
        except Exception as e:
            st.error(f"Error saving to CSV: {str(e)}")
            return False
    
    @staticmethod
    def load_assessments_from_csv() -> pd.DataFrame:
        """Load assessments from CSV with robust error handling"""
        try:
            if not os.path.exists(CSV_FILE):
                return pd.DataFrame()
            
            df = pd.read_csv(CSV_FILE, encoding='utf-8')
            
            if df.empty:
                return df
            
            # Convert timestamp
            if 'timestamp' in df.columns:
                df['timestamp'] = pd.to_datetime(df['timestamp'], errors='coerce')
            
            # Sort by timestamp
            if 'timestamp' in df.columns:
                df = df.sort_values('timestamp', ascending=False)
            
            return df
        except Exception as e:
            return pd.DataFrame()
    
    @staticmethod
    def get_statistics() -> Optional[Dict[str, Any]]:
        """Get statistics from stored assessments"""
        try:
            df = CSVDataHandler.load_assessments_from_csv()
            if df.empty:
                return None
            
            # Filter by model version if available
            if 'model_version' in df.columns:
                df = df[df['model_version'] == MODEL_VERSION]
            
            if df.empty:
                return None
            
            # Calculate statistics
            stats = {
                'total_assessments': int(len(df)),
                'model_version': MODEL_VERSION,
                'avg_financial_health': 0.0,
                'avg_risk_score': 0.0,
                'most_common_risk_category': 'N/A',
                'avg_monthly_investment': 0.0,
                'recent_assessments': []
            }
            
            # Calculate averages
            if 'financial_health_score' in df.columns:
                avg_fh = df['financial_health_score'].mean()
                if not pd.isna(avg_fh):
                    stats['avg_financial_health'] = float(avg_fh)
            
            if 'overall_risk_score' in df.columns:
                avg_risk = df['overall_risk_score'].mean()
                if not pd.isna(avg_risk):
                    stats['avg_risk_score'] = float(avg_risk)
            
            if 'risk_category' in df.columns:
                mode_result = df['risk_category'].mode()
                if not mode_result.empty:
                    stats['most_common_risk_category'] = mode_result.iloc[0]
            
            if 'monthly_investment' in df.columns:
                avg_inv = df['monthly_investment'].mean()
                if not pd.isna(avg_inv):
                    stats['avg_monthly_investment'] = float(avg_inv)
            
            # Get recent assessments
            try:
                recent_df = df.head(5).copy()
                stats['recent_assessments'] = recent_df.to_dict('records')
            except:
                stats['recent_assessments'] = []
            
            return stats
        except Exception as e:
            return None


class AssessmentPDF:
    """Generates enhanced PDF reports with explanations"""
    
    def __init__(self, assessment_data: Dict[str, Any]):
        self.data = assessment_data
        
    def generate_pdf(self):
        """Generate PDF report"""
        buffer = io.BytesIO()
        
        if REPORTLAB_AVAILABLE:
            pdf = canvas.Canvas(buffer, pagesize=letter)
            width, height = letter
            
            # Header
            pdf.setFont("Helvetica-Bold", 16)
            pdf.drawCentredString(width/2, height - 50, "Stock Risk Advisor - Assessment Report")
            pdf.setFont("Helvetica", 10)
            pdf.drawCentredString(width/2, height - 70, 
                                f"Generated on: {datetime.now().strftime('%Y-%m-%d %H:%M')}")
            pdf.drawCentredString(width/2, height - 85, f"Model Version: {MODEL_VERSION}")
            pdf.line(50, height - 95, width - 50, height - 95)
            
            y_position = height - 115
            
            # Methodology Summary
            pdf.setFont("Helvetica-Bold", 12)
            pdf.drawString(50, y_position, "Methodology Summary:")
            y_position -= 15
            pdf.setFont("Helvetica", 10)
            pdf.drawString(60, y_position, "â€¢ Based on 14 comprehensive questions")
            y_position -= 15
            pdf.drawString(60, y_position, "â€¢ Four assessment dimensions: Financial, Risk, Horizon, Knowledge")
            y_position -= 15
            pdf.drawString(60, y_position, "â€¢ Age-appropriate portfolio allocation")
            y_position -= 25
            
            # Personal Information
            pdf.setFont("Helvetica-Bold", 14)
            pdf.drawString(50, y_position, "Personal Information")
            y_position -= 20
            
            answers = self.data['answers']
            pdf.setFont("Helvetica", 12)
            pdf.drawString(50, y_position, f"Income: {self._get_income_range(answers.get('q1', 3))}")
            y_position -= 15
            pdf.drawString(50, y_position, f"Expenses: {self._get_expenses_range(answers.get('q2', 3))}")
            y_position -= 15
            pdf.drawString(50, y_position, f"Age Group: {self._get_age_group(answers.get('q14', 4))}")
            y_position -= 20
            
            # Financial Health
            pdf.setFont("Helvetica-Bold", 14)
            pdf.drawString(50, y_position, "Financial Health")
            y_position -= 20
            
            financial_data = self.data.get('financial_data', {})
            pdf.setFont("Helvetica", 12)
            pdf.drawString(50, y_position, f"Financial Health Score: {financial_data.get('financial_score', 0)}/100")
            y_position -= 15
            pdf.drawString(50, y_position, f"Emergency Fund: {self._get_emergency_status(answers.get('q3', 3))}")
            y_position -= 15
            pdf.drawString(50, y_position, f"Debt Situation: {self._get_debt_status(answers.get('q4', 3))}")
            y_position -= 20
            
            # Risk Profile
            pdf.setFont("Helvetica-Bold", 14)
            pdf.drawString(50, y_position, "Risk Profile")
            y_position -= 20
            
            pdf.setFont("Helvetica", 12)
            pdf.drawString(50, y_position, f"Risk Category: {self.data.get('risk_category', 'N/A')}")
            y_position -= 15
            risk_data = self.data.get('risk_data', {})
            pdf.drawString(50, y_position, f"Overall Risk Score: {risk_data.get('overall_risk_score', 0)}/100")
            y_position -= 20
            
            # Suitability
            investment_data = self.data.get('investment_data', {})
            suitability = investment_data.get('suitability', {})
            pdf.setFont("Helvetica-Bold", 14)
            pdf.drawString(50, y_position, "Investment Suitability")
            y_position -= 20
            
            pdf.setFont("Helvetica", 12)
            pdf.drawString(50, y_position, f"Assessment: {suitability.get('suitability', 'Unknown')}")
            y_position -= 20
            
            # Investment Recommendations
            pdf.setFont("Helvetica-Bold", 14)
            pdf.drawString(50, y_position, "Investment Recommendations")
            y_position -= 20
            
            safe_inv = investment_data.get('safe_monthly_investment', 0)
            pdf.setFont("Helvetica", 12)
            pdf.drawString(50, y_position, f"Monthly Investment: â‚¹{safe_inv:,.2f}")
            y_position -= 15
            pdf.drawString(50, y_position, f"Annual Investment: â‚¹{safe_inv * 12:,.2f}")
            y_position -= 15
            pdf.drawString(50, y_position, f"Confidence Level: {investment_data.get('investment_confidence', 'Low')}")
            y_position -= 20
            
            # Portfolio Allocation
            pdf.setFont("Helvetica-Bold", 14)
            pdf.drawString(50, y_position, "Portfolio Allocation")
            y_position -= 20
            
            allocation = self.data.get('allocation', {})
            for category, percentage in allocation.items():
                amount = (percentage / 100) * safe_inv if safe_inv > 0 else 0
                pdf.drawString(70, y_position, f"{category}: {percentage}% (â‚¹{amount:,.2f}/month)")
                y_position -= 15
                if y_position < 50:  # New page if needed
                    pdf.showPage()
                    y_position = height - 50
            
            # Stock Recommendations
            y_position -= 10
            pdf.setFont("Helvetica-Bold", 14)
            pdf.drawString(50, y_position, "Suggested Stocks")
            y_position -= 20
            
            recommendations = self.data.get('recommendations', {})
            stocks = recommendations.get('stocks', [])
            
            for i, stock in enumerate(stocks[:5]):  # Top 5 only
                pdf.setFont("Helvetica", 10)
                pdf.drawString(70, y_position, f"{i+1}. {stock.get('symbol', '')} - {stock.get('name', '')}")
                y_position -= 12
                if y_position < 50:
                    pdf.showPage()
                    y_position = height - 50
            
            # Disclaimer
            y_position -= 20
            pdf.setFont("Helvetica-Oblique", 9)
            pdf.drawString(50, y_position, "Disclaimer: This report is for educational purposes only.")
            y_position -= 12
            pdf.drawString(50, y_position, "We are not SEBI-registered investment advisors. This is not financial advice.")
            y_position -= 12
            pdf.drawString(50, y_position, "Model Version: " + MODEL_VERSION)
            
            pdf.save()
        else:
            # Text-based report if ReportLab not available
            report = self._generate_text_report()
            buffer.write(report.encode('utf-8'))
        
        buffer.seek(0)
        return buffer
    
    def _generate_text_report(self) -> str:
        """Generate text report as fallback"""
        answers = self.data['answers']
        financial_data = self.data.get('financial_data', {})
        risk_data = self.data.get('risk_data', {})
        investment_data = self.data.get('investment_data', {})
        allocation = self.data.get('allocation', {})
        recommendations = self.data.get('recommendations', {})
        
        report = f"""
        STOCK RISK ADVISOR - ASSESSMENT REPORT (v{MODEL_VERSION})
        =========================================================
        Generated on: {datetime.now().strftime('%Y-%m-%d %H:%M')}
        
        METHODOLOGY SUMMARY
        -------------------
        â€¢ 14-question comprehensive assessment
        â€¢ Four dimensions: Financial Stability, Risk Tolerance, 
          Investment Horizon, Knowledge & Experience
        â€¢ Age-appropriate portfolio allocation
        â€¢ Suitability check before recommendations
        
        PERSONAL INFORMATION
        --------------------
        Income: {self._get_income_range(answers.get('q1', 3))}
        Expenses: {self._get_expenses_range(answers.get('q2', 3))}
        Age Group: {self._get_age_group(answers.get('q14', 4))}
        
        FINANCIAL HEALTH
        ----------------
        Financial Health Score: {financial_data.get('financial_score', 0)}/100
        Emergency Fund: {self._get_emergency_status(answers.get('q3', 3))}
        Debt Situation: {self._get_debt_status(answers.get('q4', 3))}
        Savings Rate: {financial_data.get('savings_rate', 0):.1f}%
        
        RISK PROFILE
        ------------
        Risk Category: {self.data.get('risk_category', 'N/A')}
        Overall Risk Score: {risk_data.get('overall_risk_score', 0)}/100
        
        INVESTMENT SUITABILITY
        ----------------------
        Assessment: {investment_data.get('suitability', {}).get('suitability', 'Unknown')}
        {self._get_suitability_explanation(investment_data)}
        
        INVESTMENT RECOMMENDATIONS
        --------------------------
        Monthly Investment: â‚¹{investment_data.get('safe_monthly_investment', 0):,.2f}
        Annual Investment: â‚¹{investment_data.get('annual_investment', 0):,.2f}
        Confidence Level: {investment_data.get('investment_confidence', 'Low')}
        
        PORTFOLIO ALLOCATION
        --------------------
        """
        
        safe_inv = investment_data.get('safe_monthly_investment', 0)
        for category, percentage in allocation.items():
            amount = (percentage / 100) * safe_inv
            report += f"{category}: {percentage}% (â‚¹{amount:,.2f}/month)\n"
        
        report += """
        
        SUGGESTED STOCKS
        ----------------
        """
        
        stocks = recommendations.get('stocks', [])
        for i, stock in enumerate(stocks[:5]):
            report += f"{i+1}. {stock.get('symbol', '')} - {stock.get('name', '')} ({stock.get('sector', '')})\n"
        
        report += f"""
        Strategy: {recommendations.get('strategy', 'Balanced Growth')}
        
        DISCLAIMER
        ----------
        This report is for educational purposes only.
        We are not SEBI-registered investment advisors. This is not financial advice.
        Model Version: {MODEL_VERSION}
        """
        
        return report
    
    def _get_suitability_explanation(self, investment_data: Dict) -> str:
        """Get suitability explanation"""
        suitability = investment_data.get('suitability', {})
        issues = suitability.get('blocking_issues', [])
        warnings = suitability.get('warnings', [])
        
        explanation = ""
        if issues:
            explanation += "Blocking Issues:\n"
            for issue in issues:
                explanation += f"  â€¢ {issue}\n"
        
        if warnings:
            explanation += "Warnings:\n"
            for warning in warnings:
                explanation += f"  â€¢ {warning}\n"
        
        return explanation
    
    @staticmethod
    def _get_income_range(score: int) -> str:
        ranges = {
            1: "Less than â‚¹25,000",
            2: "â‚¹25,001 â€“ â‚¹50,000",
            3: "â‚¹50,001 â€“ â‚¹75,000",
            4: "â‚¹75,001 â€“ â‚¹1,00,000",
            5: "â‚¹1,00,001 â€“ â‚¹1,50,000",
            6: "Above â‚¹1,50,000"
        }
        return ranges.get(score, "â‚¹50,001 â€“ â‚¹75,000")
    
    @staticmethod
    def _get_expenses_range(score: int) -> str:
        ranges = {
            1: "Less than â‚¹20,000",
            2: "â‚¹20,001 â€“ â‚¹35,000",
            3: "â‚¹35,001 â€“ â‚¹50,000",
            4: "â‚¹50,001 â€“ â‚¹75,000",
            5: "â‚¹75,001 â€“ â‚¹1,00,000",
            6: "Above â‚¹1,00,000"
        }
        return ranges.get(score, "â‚¹35,001 â€“ â‚¹50,000")
    
    @staticmethod
    def _get_age_group(score: int) -> str:
        groups = {
            1: "Under 25 years",
            2: "25-34 years",
            3: "35-44 years",
            4: "45-54 years",
            5: "55-64 years",
            6: "65+ years"
        }
        return groups.get(score, "35-44 years")
    
    @staticmethod
    def _get_emergency_status(score: int) -> str:
        status = {
            1: "No emergency savings",
            2: "Less than 1 month",
            3: "1â€“3 months",
            4: "4â€“6 months (Recommended minimum)",
            5: "7â€“12 months",
            6: "More than 12 months"
        }
        return status.get(score, "1â€“3 months")
    
    @staticmethod
    def _get_debt_status(score: int) -> str:
        status = {
            1: "Only manageable asset debt",
            2: "Some high-interest debt but manageable",
            3: "Moderate debt load",
            4: "High-interest debt concerns",
            5: "Significant debt stress"
        }
        return status.get(score, "Moderate debt load")


# ============================================================================
# STREAMLIT APP
# ============================================================================

# Page Configuration
st.set_page_config(
    page_title=APP_TITLE,
    page_icon=APP_ICON,
    layout="wide",
    initial_sidebar_state="expanded"
)

# Enhanced Custom CSS
st.markdown("""
<style>
    .main-header { font-size: 2.5rem; color: #1E3A8A; font-weight: 700; margin-bottom: 1rem; }
    .section-header { font-size: 1.8rem; color: #374151; font-weight: 600; margin: 1.5rem 0 1rem 0; }
    .card { 
        background-color: white; 
        padding: 1.5rem; 
        border-radius: 10px; 
        border-left: 5px solid #3B82F6; 
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .metric-card { 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        color: white; 
        padding: 1.5rem; 
        border-radius: 10px; 
        text-align: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .progress-bar { 
        height: 10px; 
        background-color: #E5E7EB; 
        border-radius: 5px; 
        margin: 10px 0; 
        overflow: hidden; 
    }
    .progress-fill { 
        height: 100%; 
        border-radius: 5px; 
        transition: width 0.5s ease; 
    }
    .stButton > button { 
        background-color: #3B82F6; 
        color: white; 
        font-weight: 600; 
        border-radius: 8px; 
        padding: 0.5rem 1rem; 
        border: none;
        width: 100%;
    }
    .stButton > button:hover { 
        background-color: #2563EB; 
        color: white;
    }
    .info-box { 
        background-color: #E0F2FE; 
        border-left: 4px solid #0EA5E9; 
        padding: 1rem; 
        border-radius: 8px; 
        margin: 1rem 0;
    }
    .warning-box { 
        background-color: #FEF3C7; 
        border-left: 4px solid #F59E0B; 
        padding: 1rem; 
        border-radius: 8px; 
        margin: 1rem 0;
    }
    .success-box { 
        background-color: #D1FAE5; 
        border-left: 4px solid #10B981; 
        padding: 1rem; 
        border-radius: 8px; 
        margin: 1rem 0;
    }
    .danger-box { 
        background-color: #FEE2E2; 
        border-left: 4px solid #EF4444; 
        padding: 1rem; 
        border-radius: 8px; 
        margin: 1rem 0;
    }
    .part-header {
        background: linear-gradient(90deg, #3B82F6, #8B5CF6);
        color: white;
        padding: 1rem;
        border-radius: 8px;
        margin: 2rem 0 1rem 0;
        font-size: 1.2rem;
        font-weight: 600;
    }
    .tooltip-icon {
        color: #6B7280;
        cursor: help;
        margin-left: 5px;
    }
    .question-explanation {
        background-color: #F9FAFB;
        padding: 0.75rem;
        border-radius: 6px;
        margin: 0.5rem 0;
        border-left: 3px solid #D1D5DB;
        font-size: 0.9rem;
        color: #4B5563;
    }
</style>
""", unsafe_allow_html=True)

# Initialize Session State
def init_session_state():
    defaults = {
        'current_tab': "Welcome",
        'answers': {},
        'risk_data': None,
        'risk_category': None,
        'financial_data': None,
        'safe_investment': None,
        'assessment_complete': False,
        'allocation': None,
        'recommendations': None,
        'assessment_id': None,
        'validation_warnings': []
    }
    
    for key, value in defaults.items():
        if key not in st.session_state:
            st.session_state[key] = value

init_session_state()

# ============================================================================
# HELPER FUNCTIONS WITH ENHANCED UI
# ============================================================================

def calculate_results():
    """Calculate all assessment results with validation"""
    calculator = RiskCalculator()
    
    # Validate answers first
    is_valid, warnings = calculator.validate_answers(st.session_state.answers)
    
    if warnings:
        st.session_state.validation_warnings = warnings
    
    if not is_valid:
        st.error("Please complete all questions before calculating results.")
        return
    
    # Calculate scores
    risk_data = calculator.calculate_overall_risk_score(st.session_state.answers)
    financial_data = risk_data['financial_data']
    risk_category = calculator.get_risk_category(risk_data['overall_risk_score'])
    
    # Check suitability
    suitability = calculator.check_investment_suitability(st.session_state.answers, financial_data)
    
    # Determine portfolio allocation
    allocation = calculator.determine_portfolio_allocation(
        risk_data['overall_risk_score'], st.session_state.answers
    )
    
    # Calculate safe investment
    investment_data = calculator.calculate_safe_investment(
        st.session_state.answers, financial_data, risk_data
    )
    
    # Get stock recommendations
    recommendations = calculator.get_stock_recommendations(risk_category, allocation)
    
    # Update session state
    st.session_state.financial_data = financial_data
    st.session_state.risk_data = risk_data
    st.session_state.risk_category = risk_category
    st.session_state.allocation = allocation
    st.session_state.safe_investment = investment_data
    st.session_state.recommendations = recommendations
    st.session_state.assessment_complete = True
    st.session_state.assessment_id = datetime.now().strftime("%Y%m%d_%H%M%S")
    st.session_state.current_tab = "Financial Health"
    
    # Save to CSV
    assessment_data = {
        'answers': st.session_state.answers,
        'financial_data': financial_data,
        'risk_data': risk_data,
        'risk_category': risk_category,
        'allocation': allocation,
        'investment_data': investment_data,
        'recommendations': recommendations
    }
    
    if CSVDataHandler.save_assessment_to_csv(assessment_data):
        st.success("âœ… Assessment saved successfully!")
    
    st.rerun()


def create_question_with_explanation(question_num, title, options, format_func, 
                                     help_text, example=None, key=None):
    """Create standardized question with explanation box"""
    st.markdown(f"#### Q{question_num}: {title}")
    
    # Help text in expander
    with st.expander("â„¹ï¸ Why we ask this & how to answer"):
        st.markdown(help_text)
        if example:
            st.markdown(f"**Example:** {example}")
    
    # Create selectbox
    return st.selectbox(
        f"Select your {title.lower()}:",
        options=options,
        format_func=format_func,
        index=st.session_state.answers.get(key, 3) - 1 if key in st.session_state.answers else 2,
        key=key
    )


def show_section_explanation(title, description, key_points=None):
    """Show section explanation box"""
    st.markdown(f"""
    <div class="info-box">
        <strong>ðŸ“‹ {title}</strong><br>
        {description}
    </div>
    """, unsafe_allow_html=True)
    
    if key_points:
        st.markdown("**Key points to consider:**")
        for point in key_points:
            st.markdown(f"â€¢ {point}")


def create_navigation_buttons():
    """Create navigation buttons"""
    tabs = ["Welcome", "Assessment", "Financial Health", "Risk Profile", 
            "Recommendations", "Action Plan", "Data & Export"]
    current = st.session_state.current_tab
    idx = tabs.index(current) if current in tabs else 0
    
    col1, col2, col3 = st.columns([1, 2, 1])
    
    with col1:
        if idx > 0 and current != "Welcome":
            if st.button("â—€ï¸ Previous", use_container_width=True):
                st.session_state.current_tab = tabs[idx - 1]
                st.rerun()
    
    with col3:
        if idx < len(tabs) - 1 and current != "Data & Export":
            if current == "Assessment" and not st.session_state.assessment_complete:
                if st.button("Calculate Results â–¶ï¸", type="primary", use_container_width=True):
                    calculate_results()
            else:
                if st.button("Next â–¶ï¸", type="primary", use_container_width=True):
                    st.session_state.current_tab = tabs[idx + 1]
                    st.rerun()


def create_progress_bar():
    """Create progress bar"""
    tabs = ["Welcome", "Assessment", "Financial Health", "Risk Profile", 
            "Recommendations", "Action Plan", "Data & Export"]
    current = st.session_state.current_tab
    idx = tabs.index(current) if current in tabs else 0
    
    # Create tab labels
    tab_labels = []
    for i, tab in enumerate(tabs):
        if i == idx:
            tab_labels.append(f'<span style="font-weight: bold; color: #3B82F6;">{tab}</span>')
        else:
            tab_labels.append(f'<span style="font-weight: normal; color: #6B7280;">{tab}</span>')
    
    progress_html = f"""
    <div style="margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            {"".join(tab_labels)}
        </div>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {(idx + 1)/len(tabs)*100}%; 
                 background-color: #3B82F6;"></div>
        </div>
    </div>
    """
    st.markdown(progress_html, unsafe_allow_html=True)


def show_calculation_methodology():
    """Show how recommendations were calculated"""
    with st.expander("ðŸ”¬ How we calculated your results", expanded=False):
        st.markdown("""
        ### Assessment Methodology (v2.1)
        
        Your recommendations are based on a **multi-dimensional assessment** across four key areas:
        
        #### 1. Financial Stability (30% weight)
        - Emergency Fund Status (40%)
        - Debt Situation (35%)
        - Savings Rate (25%)
        
        #### 2. Risk Tolerance (30% weight)
        - Importance of Avoiding Loss (30%)
        - Emotional Reaction to Market Drops (25%)
        - Maximum Tolerable Loss (30%)
        - View on Market Volatility (15%)
        
        #### 3. Investment Horizon (20% weight)
        - Primary Investment Goal (40%)
        - Timeframe Length (40%)
        - Liquidity Needs (20%)
        
        #### 4. Knowledge & Experience (20% weight)
        - Stock Investing Experience (60%)
        - Knowledge Level (40%)
        
        #### Portfolio Allocation Logic
        - **Age-Adjusted**: Younger investors get higher equity allocation
        - **Risk-Adjusted**: Higher risk tolerance increases growth allocation
        - **Suitability Check**: Emergency fund and debt are checked first
        
        #### Investment Amount Calculation
        - **Base**: Percentage of disposable income
        - **Adjusted by**: Financial health, risk tolerance, timeframe
        - **Capped at**: 30% of available funds
        - **Minimum**: â‚¹500/month threshold
        
        #### Model Features
        - No double-counting of factors
        - Realistic Indian income/expense ranges
        - Suitability checks before recommendations
        - Transparent weighting system
        """)
        
        # Show actual weights if available
        if st.session_state.risk_data:
            st.markdown(f"""
            #### Your Actual Weights Used
            - Financial Stability: **{WEIGHTS['financial_stability']*100}%**
            - Risk Tolerance: **{WEIGHTS['risk_tolerance']*100}%**
            - Investment Horizon: **{WEIGHTS['investment_horizon']*100}%**
            - Knowledge & Experience: **{WEIGHTS['knowledge_experience']*100}%**
            
            **Model Version:** {MODEL_VERSION}
            """)

# ============================================================================
# TAB FUNCTIONS WITH ENHANCED UI
# ============================================================================

def create_assessment_tab():
    """Create the assessment tab with enhanced UI and explanations"""
    st.markdown('<h1 class="main-header">ðŸ“‹ Comprehensive Stock Investment Assessment</h1>', unsafe_allow_html=True)
    
    # Progress indicator
    answered = len([v for v in st.session_state.answers.values() if v is not None])
    progress = min(100, int((answered / 14) * 100))
    
    st.markdown(f"""
    <div style="margin: 1.5rem 0;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span>Assessment Progress</span>
            <span>{answered}/14 questions answered</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {progress}%;"></div>
        </div>
    </div>
    """, unsafe_allow_html=True)
    
    # Show validation warnings if any
    if st.session_state.validation_warnings:
        for warning in st.session_state.validation_warnings:
            st.warning(warning)
    
    with st.form("assessment_form"):
        # Part 1: Financial Foundation
        st.markdown('<div class="part-header">ðŸŸ¦ PART 1: FINANCIAL FOUNDATION</div>', unsafe_allow_html=True)
        
        show_section_explanation(
            "Financial Foundation Assessment",
            "This section evaluates your basic financial health before considering stock investments. "
            "We check if you have sufficient emergency funds, manageable debt, and positive cash flow.",
            [
                "Emergency fund should cover 3-6 months of expenses",
                "High-interest debt should be prioritized over investing",
                "Positive savings rate enables investment"
            ]
        )
        
        col1, col2 = st.columns(2)
        with col1:
            q1 = create_question_with_explanation(
                1, "Monthly Take-home Income",
                options=[1, 2, 3, 4, 5, 6],
                format_func=lambda x: [
                    "Less than â‚¹25,000",
                    "â‚¹25,001 â€“ â‚¹50,000",
                    "â‚¹50,001 â€“ â‚¹75,000",
                    "â‚¹75,001 â€“ â‚¹1,00,000",
                    "â‚¹1,00,001 â€“ â‚¹1,50,000",
                    "Above â‚¹1,50,000"
                ][x-1],
                help_text="Your monthly income after all deductions (tax, PF, EMI). "
                        "This helps determine how much you can safely invest without affecting essential expenses.",
                example="If your take-home salary is â‚¹68,000, choose â‚¹50,001 â€“ â‚¹75,000",
                key="q1_form"
            )
        
        with col2:
            q2 = create_question_with_explanation(
                2, "Monthly Essential Expenses",
                options=[1, 2, 3, 4, 5, 6],
                format_func=lambda x: [
                    "Less than â‚¹20,000",
                    "â‚¹20,001 â€“ â‚¹35,000",
                    "â‚¹35,001 â€“ â‚¹50,000",
                    "â‚¹50,001 â€“ â‚¹75,000",
                    "â‚¹75,001 â€“ â‚¹1,00,000",
                    "Above â‚¹1,00,000"
                ][x-1],
                help_text="Your monthly essential living expenses (rent, food, utilities, EMIs, insurance). "
                        "Do NOT include investments, savings, or discretionary spending.",
                example="If rent (â‚¹15,000) + food (â‚¹8,000) + bills (â‚¹5,000) = â‚¹28,000, choose â‚¹20,001 â€“ â‚¹35,000",
                key="q2_form"
            )
        
        col1, col2 = st.columns(2)
        with col1:
            q3 = create_question_with_explanation(
                3, "Emergency Fund Coverage",
                options=[1, 2, 3, 4, 5, 6],
                format_func=lambda x: [
                    "No emergency savings",
                    "Less than 1 month of expenses",
                    "1â€“3 months of expenses",
                    "4â€“6 months (Recommended minimum)",
                    "7â€“12 months of expenses",
                    "More than 12 months"
                ][x-1],
                help_text="Emergency fund is cash savings for unexpected expenses (medical, job loss, repairs). "
                        "This is CRITICAL before investing in stocks.",
                example="If monthly expenses are â‚¹40,000 and you have â‚¹2 lakh saved, you have 5 months coverage",
                key="q3_form"
            )
        
        with col2:
            q4 = create_question_with_explanation(
                4, "Debt Situation",
                options=[1, 2, 3, 4, 5],
                format_func=lambda x: [
                    "Only manageable asset debt",
                    "Some high-interest debt but manageable",
                    "Moderate debt load",
                    "High-interest debt concerns",
                    "Significant debt stress"
                ][x-1],
                help_text="High-interest debt (credit cards, personal loans >12%) should be paid before stock investing. "
                        "Low-interest debt (home loan <9%) is usually manageable.",
                example="Credit card debt at 24% interest is high-priority; home loan at 8.5% is lower priority",
                key="q4_form"
            )
        
        # Validation check for income vs expenses
        if INCOME_MAP.get(q1, 0) < EXPENSES_MAP.get(q2, 0) * 0.9:
            st.warning("âš ï¸ Your expenses seem high relative to income. Please double-check your entries.")
        
        # Part 2: Goals & Timeframe
        st.markdown('<div class="part-header">ðŸŸ¦ PART 2: INVESTMENT GOALS & TIMEFRAME</div>', unsafe_allow_html=True)
        
        show_section_explanation(
            "Investment Goals & Timeframe",
            "Understanding your investment purpose and timeline helps recommend appropriate strategies. "
            "Different goals require different risk levels and time horizons.",
            [
                "Short-term goals (<3 years) need safer investments",
                "Long-term goals (>7 years) can tolerate more risk",
                "Specific goals need specific strategies"
            ]
        )
        
        col1, col2 = st.columns(2)
        with col1:
            q5 = create_question_with_explanation(
                5, "Primary Investment Goal",
                options=[1, 2, 3, 4, 5, 6],
                format_func=lambda x: [
                    "Capital Preservation",
                    "Regular Income",
                    "Major Life Goal",
                    "Retirement Planning",
                    "Wealth Creation",
                    "Not Sure"
                ][x-1],
                help_text="Your main reason for investing determines the strategy. "
                        "Capital preservation is safest; wealth creation accepts more risk.",
                example="Saving for house down payment in 5 years = Major Life Goal",
                key="q5_form"
            )
        
        with col2:
            q6 = create_question_with_explanation(
                6, "Investment Timeframe",
                options=[1, 2, 3, 4, 5, 6],
                format_func=lambda x: [
                    "Less than 2 years",
                    "2â€“4 years",
                    "5â€“7 years",
                    "8â€“12 years",
                    "13+ years",
                    "Multiple timeframes"
                ][x-1],
                help_text="How long can you keep the money invested without needing it? "
                        "Longer timeframes allow more risk for higher potential returns.",
                example="Retirement in 20 years = 13+ years; Vacation next year = Less than 2 years",
                key="q6_form"
            )
        
        q7 = create_question_with_explanation(
            7, "Importance of Avoiding Loss",
            options=[1, 2, 3, 4, 5, 6],
            format_func=lambda x: [
                "Critical - Cannot afford any loss",
                "Very Important - Losses problematic",
                "Important - Prefer stability",
                "Moderate - Tolerate some loss",
                "Flexible - Calculated risks",
                "Growth Focused - Comfortable with volatility"
            ][x-1],
            help_text="How important is it that your investment never goes down in value? "
                    "All stocks can decline; your comfort with this affects recommendations.",
            example="Money for daughter's wedding next year = Critical; Retirement fund = Growth Focused",
            key="q7_form"
        )
        
        # Part 3: Risk Psychology
        st.markdown('<div class="part-header">ðŸŸ¦ PART 3: RISK BEHAVIOR & PSYCHOLOGY</div>', unsafe_allow_html=True)
        
        show_section_explanation(
            "Risk Psychology Assessment",
            "This section measures your emotional and psychological relationship with risk and volatility. "
            "Understanding your true risk tolerance prevents panic selling during market declines.",
            [
                "Be honest about how you'd react to losses",
                "Past experience influences current tolerance",
                "Risk tolerance often decreases with age"
            ]
        )
        
        col1, col2 = st.columns(2)
        with col1:
            q8 = create_question_with_explanation(
                8, "Reaction to 20% Market Drop",
                options=[1, 2, 3, 4, 5],
                format_func=lambda x: [
                    "Sell to avoid further loss",
                    "Reduce position but keep some",
                    "Hold nervously but wait",
                    "Stay calm and ride out",
                    "See as buying opportunity"
                ][x-1],
                help_text="Stocks regularly decline 20%+. Your reaction shows true risk tolerance. "
                        "Panic selling locks in losses; staying invested usually recovers.",
                example="During COVID crash (March 2020), markets fell ~35% but recovered in months",
                key="q8_form"
            )
        
        with col2:
            q9 = create_question_with_explanation(
                9, "Maximum Tolerable Loss",
                options=[1, 2, 3, 4, 5, 6],
                format_func=lambda x: [
                    "0â€“5% - Very conservative",
                    "6â€“15% - Conservative",
                    "16â€“25% - Moderate",
                    "26â€“35% - Aggressive",
                    "36â€“50% - Very aggressive",
                    "More than 50% - Speculative"
                ][x-1],
                help_text="What maximum loss could you tolerate without panicking? "
                        "Realistic assessment prevents stress during market corrections.",
                example="If you invest â‚¹1 lakh, could you handle it dropping to â‚¹75,000 (25% loss)?",
                key="q9_form"
            )
        
        q10 = create_question_with_explanation(
            10, "View on Market Volatility",
            options=[1, 2, 3, 4, 5, 6],
            format_func=lambda x: [
                "Stressful and scary",
                "Uncomfortable but manageable",
                "Normal part of investing",
                "Opportunity for better prices",
                "Exciting and engaging",
                "Analytical perspective"
            ][x-1],
            help_text="Volatility is normal in stock markets. Your emotional response affects investment decisions.",
            example="Daily price swings of 2-3% are normal; yearly declines of 10-20% occur regularly",
            key="q10_form"
        )
        
        # Part 4: Experience & Personal
        st.markdown('<div class="part-header">ðŸŸ¦ PART 4: EXPERIENCE & PERSONAL FACTORS</div>', unsafe_allow_html=True)
        
        show_section_explanation(
            "Experience & Personal Factors",
            "Your investing experience, knowledge, and personal circumstances affect appropriate recommendations. "
            "Beginners need different guidance than experienced investors.",
            [
                "Beginners should start simple and learn gradually",
                "Experience helps during market turbulence",
                "Personal circumstances affect risk capacity"
            ]
        )
        
        col1, col2 = st.columns(2)
        with col1:
            q11 = create_question_with_explanation(
                11, "Stock Investing Experience",
                options=[1, 2, 3, 4, 5, 6],
                format_func=lambda x: [
                    "First-time investor",
                    "Beginner (<1 year)",
                    "Intermediate (1-3 years)",
                    "Experienced (3-7 years)",
                    "Advanced (7+ years)",
                    "Professional background"
                ][x-1],
                help_text="Practical experience with stock investing, including market cycles. "
                        "Experience helps manage emotions during volatility.",
                example="Have you bought/sold stocks before? For how long? Through which platform?",
                key="q11_form"
            )
        
        with col2:
            q12 = create_question_with_explanation(
                12, "Stock Investing Knowledge",
                options=[1, 2, 3, 4, 5, 6],
                format_func=lambda x: [
                    "Very Limited",
                    "Basic",
                    "Intermediate",
                    "Good",
                    "Advanced",
                    "Expert"
                ][x-1],
                help_text="Understanding of stock market concepts (P/E ratio, diversification, sectors). "
                        "Knowledge helps make informed decisions.",
                example="Do you understand terms like market cap, dividends, earnings reports?",
                key="q12_form"
            )
        
        col1, col2 = st.columns(2)
        with col1:
            q13 = create_question_with_explanation(
                13, "Liquidity Needs",
                options=[1, 2, 3, 4, 5, 6],
                format_func=lambda x: [
                    "Very likely (within 1 year)",
                    "Likely (1-2 years)",
                    "Possible (2-3 years)",
                    "Unlikely (3-5 years)",
                    "Very unlikely (5+ years)",
                    "Never â€“ long-term only"
                ][x-1],
                help_text="How likely will you need to withdraw this money? "
                        "Stocks are not suitable for short-term needs due to volatility.",
                example="Emergency medical fund = Very likely; Retirement fund = Very unlikely",
                key="q13_form"
            )
        
        with col2:
            q14 = create_question_with_explanation(
                14, "Age Group",
                options=[1, 2, 3, 4, 5, 6],
                format_func=lambda x: [
                    "Under 25 years",
                    "25-34 years",
                    "35-44 years",
                    "45-54 years",
                    "55-64 years",
                    "65+ years"
                ][x-1],
                help_text="Age affects investment strategy (younger = more growth focus, older = more stability). "
                        "Based on '100 minus age' rule for equity allocation.",
                example="Age 30: up to 70% in stocks; Age 60: up to 40% in stocks",
                key="q14_form"
            )
        
        # Submit button
        col1, col2, col3 = st.columns([1, 2, 1])
        with col2:
            submitted = st.form_submit_button(
                "ðŸš€ Calculate My Personalized Investment Plan",
                type="primary",
                use_container_width=True
            )
        
        if submitted:
            # Save answers
            st.session_state.answers.update({
                'q1': q1, 'q2': q2, 'q3': q3, 'q4': q4,
                'q5': q5, 'q6': q6, 'q7': q7, 'q8': q8,
                'q9': q9, 'q10': q10, 'q11': q11, 'q12': q12,
                'q13': q13, 'q14': q14
            })
            
            # Clear any previous warnings
            st.session_state.validation_warnings = []
            
            # Calculate results
            calculate_results()


def create_financial_health_tab():
    """Create financial health dashboard with explanations"""
    st.markdown('<h1 class="main-header">ðŸ’° Financial Health Assessment</h1>', unsafe_allow_html=True)
    
    if not st.session_state.assessment_complete:
        st.warning("Please complete the assessment first!")
        if st.button("Go to Assessment"):
            st.session_state.current_tab = "Assessment"
            st.rerun()
        return
    
    financial_data = st.session_state.financial_data
    
    # Section explanation
    show_section_explanation(
        "Your Financial Health Score",
        "This score evaluates your readiness for stock investing based on emergency funds, debt, and savings. "
        "Higher scores indicate stronger financial foundation for investing.",
        [
            "Score 0-40: Focus on emergency fund and debt reduction",
            "Score 41-70: Moderate readiness, proceed with caution",
            "Score 71-100: Strong foundation for investing"
        ]
    )
    
    # Metrics with explanations
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        score = financial_data['financial_score']
        color = "#10B981" if score >= 70 else "#F59E0B" if score >= 50 else "#EF4444"
        st.markdown(f"""
        <div class="metric-card">
            <h3 style="margin: 0; font-size: 1.1rem;">Financial Health Score</h3>
            <h1 style="margin: 0.5rem 0; font-size: 2.5rem;">{score}/100</h1>
            <p style="margin: 0;">{'ðŸŸ¢ Strong Foundation' if score >= 70 else 'ðŸŸ¡ Needs Improvement' if score >= 50 else 'ðŸ”´ Requires Attention'}</p>
        </div>
        """, unsafe_allow_html=True)
        
        with st.expander("What this means"):
            if score >= 70:
                st.success("Your financial foundation is strong. You can confidently consider stock investments.")
            elif score >= 50:
                st.info("Your finances are reasonable but could be improved. Consider addressing weaknesses before significant investing.")
            else:
                st.warning("Focus on building emergency fund and reducing debt before stock investing.")
    
    with col2:
        disposable = financial_data['disposable_income']
        monthly_income = financial_data['monthly_income']
        pct = (disposable / monthly_income * 100) if monthly_income > 0 else 0
        
        st.markdown(f"""
        <div class="card">
            <h4 style="margin: 0;">Monthly Disposable Income</h4>
            <h2 style="margin: 0.5rem 0; color: #3B82F6;">â‚¹{disposable:,.0f}</h2>
            <p style="margin: 0; color: #6B7280;">{pct:.1f}% of income</p>
        </div>
        """, unsafe_allow_html=True)
        
        with st.expander("About this metric"):
            st.markdown("""
            **Disposable Income = Income - Essential Expenses**
            
            This is the amount available for:
            â€¢ Emergency fund building
            â€¢ Debt repayment
            â€¢ Investments
            â€¢ Discretionary spending
            
            **Healthy target:** 20-30% of take-home income
            """)
    
    with col3:
        savings = financial_data['savings_rate']
        color = "#10B981" if savings >= 20 else "#F59E0B" if savings >= 10 else "#EF4444"
        st.markdown(f"""
        <div class="card" style="border-left-color: {color};">
            <h4 style="margin: 0;">Savings Rate</h4>
            <h2 style="margin: 0.5rem 0; color: {color};">{savings:.1f}%</h2>
            <p style="margin: 0; color: #6B7280;">{'ðŸŸ¢ Good' if savings >= 20 else 'ðŸŸ¡ Okay' if savings >= 10 else 'ðŸ”´ Low'}</p>
        </div>
        """, unsafe_allow_html=True)
        
        with st.expander("Savings rate guidance"):
            st.markdown("""
            **Recommended savings rates:**
            â€¢ **20%+:** Excellent - Strong investing capacity
            â€¢ **10-19%:** Good - Room for improvement
            â€¢ **<10%:** Low - Focus on increasing income/reducing expenses
            
            **Note:** This is savings rate from take-home pay, not gross salary.
            """)
    
    with col4:
        emergency_months = financial_data['emergency_months']
        color = "#10B981" if emergency_months >= 6 else "#F59E0B" if emergency_months >= 3 else "#EF4444"
        st.markdown(f"""
        <div class="card" style="border-left-color: {color};">
            <h4 style="margin: 0;">Emergency Fund</h4>
            <h2 style="margin: 0.5rem 0; color: {color};">{emergency_months:.1f} months</h2>
            <p style="margin: 0; color: #6B7280;">{'ðŸŸ¢ Adequate' if emergency_months >= 6 else 'ðŸŸ¡ Moderate' if emergency_months >= 3 else 'ðŸ”´ Insufficient'}</p>
        </div>
        """, unsafe_allow_html=True)
        
        with st.expander("Emergency fund importance"):
            st.markdown("""
            **Why emergency fund comes first:**
            1. Prevents selling investments during emergencies
            2. Reduces financial stress
            3. Avoids high-interest debt
            
            **Recommended:** 3-6 months of essential expenses
            **High risk jobs:** 6-12 months recommended
            """)
    
    # Components Breakdown with detailed explanations
    st.markdown('<h3 class="section-header">ðŸ“Š Components Breakdown</h3>', unsafe_allow_html=True)
    
    components = [
        ("Emergency Fund", financial_data['emergency_component'], "#3B82F6",
         "Adequate emergency savings before investing"),
        ("Debt Status", financial_data['debt_component'], "#10B981",
         "Managing high-interest debt effectively"),
        ("Savings Rate", financial_data['savings_component'], "#8B5CF6",
         "Positive cash flow enabling investments")
    ]
    
    for label, score, color, description in components:
        st.markdown(f"""
        <div style="margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <div>
                    <span style="font-weight: 600;">{label}</span>
                    <span style="font-size: 0.9rem; color: #6B7280; margin-left: 10px;">{description}</span>
                </div>
                <span style="font-weight: 600; color: {color};">{score:.0f}/100</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {score}%; background-color: {color};"></div>
            </div>
        </div>
        """, unsafe_allow_html=True)
    
    # Show calculation methodology
    show_calculation_methodology()
    
    create_navigation_buttons()


def create_risk_profile_tab():
    """Create risk profile analysis with explanations"""
    st.markdown('<h1 class="main-header">ðŸŽ¯ Risk Profile Analysis</h1>', unsafe_allow_html=True)
    
    if not st.session_state.assessment_complete:
        st.warning("Please complete the assessment first!")
        if st.button("Go to Assessment"):
            st.session_state.current_tab = "Assessment"
            st.rerun()
        return
    
    risk_data = st.session_state.risk_data
    risk_category = st.session_state.risk_category
    
    # Section explanation
    show_section_explanation(
        "Your Risk Profile",
        "This profile combines your financial situation, psychological tolerance, investment horizon, "
        "and experience to determine appropriate investment risk level.",
        [
            "Higher risk tolerance allows more aggressive investments",
            "Risk profile should match your emotional comfort",
            "Different profiles require different strategies"
        ]
    )
    
    # Risk Category
    category_colors = {
        "VERY LOW RISK": "#10B981", "LOW RISK": "#34D399",
        "MEDIUM RISK": "#F59E0B", "HIGH RISK": "#F97316",
        "VERY HIGH RISK": "#EF4444"
    }
    
    color = category_colors.get(risk_category, "#6B7280")
    
    col1, col2 = st.columns([2, 1])
    with col1:
        st.markdown(f"""
        <div style="background-color: {color}20; padding: 1.5rem; border-radius: 10px; 
                    border-left: 5px solid {color}; margin-bottom: 1rem;">
            <h2 style="margin: 0; color: {color};">{risk_category}</h2>
            <p style="margin: 0.5rem 0 0 0; color: #6B7280;">Based on 14-question multi-dimensional assessment</p>
        </div>
        """, unsafe_allow_html=True)
        
        with st.expander("What this risk category means"):
            if risk_category == "VERY LOW RISK":
                st.info("""
                **Conservative Investor**
                - Prefers stability over growth
                - Low tolerance for volatility
                - Shorter time horizon or immediate needs
                - Focus on capital preservation
                """)
            elif risk_category == "LOW RISK":
                st.info("""
                **Cautious Investor**
                - Some growth acceptable
                - Limited volatility tolerance
                - May have medium-term goals
                - Balanced approach
                """)
            elif risk_category == "MEDIUM RISK":
                st.info("""
                **Moderate Investor**
                - Balance of growth and safety
                - Moderate volatility tolerance
                - Medium to long-term horizon
                - Diversified approach
                """)
            elif risk_category == "HIGH RISK":
                st.info("""
                **Growth Investor**
                - Prioritizes growth over safety
                - Higher volatility tolerance
                - Long-term time horizon
                - Aggressive approach
                """)
            else:  # VERY HIGH RISK
                st.info("""
                **Aggressive Investor**
                - Maximizes growth potential
                - High volatility tolerance
                - Very long-term horizon
                - Speculative approach
                """)
    
    with col2:
        score = risk_data['overall_risk_score']
        st.markdown(f"""
        <div class="card">
            <h4 style="margin: 0;">Overall Risk Score</h4>
            <h2 style="margin: 0.5rem 0; color: {color};">{score:.0f}/100</h2>
            <p style="margin: 0; color: #6B7280;">0-100 scale (higher = more risk tolerant)</p>
        </div>
        """, unsafe_allow_html=True)
    
    # Components with detailed explanations
    st.markdown('<h3 class="section-header">ðŸ“Š Risk Score Components</h3>', unsafe_allow_html=True)
    
    components = [
        ("Financial Stability", risk_data['financial_data']['financial_score'], "#3B82F6",
         "Your financial foundation readiness"),
        ("Risk Tolerance", risk_data['risk_tolerance_data']['risk_tolerance_score'], "#10B981",
         "Psychological comfort with risk and volatility"),
        ("Investment Horizon", risk_data['horizon_data']['horizon_score'], "#8B5CF6",
         "Time available for investments to grow"),
        ("Knowledge & Experience", risk_data['knowledge_data']['knowledge_score'], "#F59E0B",
         "Your investing knowledge and practical experience")
    ]
    
    # Show weights used
    weights = risk_data.get('weights_used', WEIGHTS)
    
    for (label, score, color, description), weight_key in zip(
        components, 
        ['financial_stability', 'risk_tolerance', 'investment_horizon', 'knowledge_experience']
    ):
        weight = weights.get(weight_key, 0.25) * 100
        
        st.markdown(f"""
        <div style="margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <div>
                    <span style="font-weight: 600;">{label}</span>
                    <span style="font-size: 0.9rem; color: #6B7280; margin-left: 10px;">{description}</span>
                    <span style="font-size: 0.8rem; color: #9CA3AF; margin-left: 10px;">(Weight: {weight:.0f}%)</span>
                </div>
                <span style="font-weight: 600; color: {color};">{score:.0f}/100</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {score}%; background-color: {color};"></div>
            </div>
        </div>
        """, unsafe_allow_html=True)
    
    # Risk tolerance details
    st.markdown('<h3 class="section-header">ðŸŽ­ Risk Tolerance Details</h3>', unsafe_allow_html=True)
    
    risk_tolerance = risk_data['risk_tolerance_data']
    col1, col2, col3 = st.columns(3)
    
    with col1:
        max_loss = risk_tolerance.get('max_tolerable_loss_pct', 20.5)
        st.metric("Maximum Tolerable Loss", f"{max_loss:.1f}%")
    
    with col2:
        components = risk_tolerance.get('components', {})
        emotional = components.get('emotional', 50)
        st.metric("Emotional Stability", f"{emotional:.0f}/100")
    
    with col3:
        volatility = components.get('volatility_view', 50) if 'components' in risk_tolerance else 50
        st.metric("Volatility Comfort", f"{volatility:.0f}/100")
    
    # Show calculation methodology
    show_calculation_methodology()
    
    create_navigation_buttons()


def create_recommendations_tab():
    """Create investment recommendations with enhanced explanations"""
    st.markdown('<h1 class="main-header">ðŸ’¼ Stock Investment Recommendations</h1>', unsafe_allow_html=True)
    
    if not st.session_state.assessment_complete:
        st.warning("Please complete the assessment first!")
        if st.button("Go to Assessment"):
            st.session_state.current_tab = "Assessment"
            st.rerun()
        return
    
    allocation = st.session_state.allocation
    investment_data = st.session_state.safe_investment
    recommendations = st.session_state.recommendations
    
    # Suitability check
    suitability = investment_data.get('suitability', {})
    
    if suitability.get('suitability') == "NOT SUITABLE":
        st.markdown('<div class="danger-box">', unsafe_allow_html=True)
        st.error("âš ï¸ **Not Currently Suitable for Stock Investing**")
        st.markdown(f"""
        **Recommendation:** {suitability.get('recommendation', '')}
        
        **Blocking Issues:**
        """)
        for issue in suitability.get('blocking_issues', []):
            st.markdown(f"â€¢ {issue}")
        st.markdown('</div>', unsafe_allow_html=True)
    elif suitability.get('suitability') == "CAUTION ADVISED":
        st.markdown('<div class="warning-box">', unsafe_allow_html=True)
        st.warning("âš ï¸ **Caution Advised for Stock Investing**")
        st.markdown(f"""
        **Recommendation:** {suitability.get('recommendation', '')}
        
        **Warnings to Address:**
        """)
        for warning in suitability.get('warnings', []):
            st.markdown(f"â€¢ {warning}")
        st.markdown('</div>', unsafe_allow_html=True)
    else:
        st.markdown('<div class="success-box">', unsafe_allow_html=True)
        st.success("âœ… **Suitable for Stock Investing**")
        st.markdown(f"**Recommendation:** {suitability.get('recommendation', 'Proceed with recommended plan')}")
        st.markdown('</div>', unsafe_allow_html=True)
    
    # Section explanation
    show_section_explanation(
        "Your Investment Recommendations",
        "These recommendations are personalized based on your risk profile, financial situation, "
        "and investment goals. They balance growth potential with appropriate risk levels.",
        [
            "Allocation matches your risk tolerance",
            "Amount is sustainable based on your finances",
            "Stocks are selected for your profile"
        ]
    )
    
    # Investment Summary with explanations
    col1, col2, col3 = st.columns(3)
    
    with col1:
        monthly = investment_data['safe_monthly_investment']
        conf = investment_data['investment_confidence']
        conf_color = "#10B981" if "High" in conf or "Very High" in conf else "#F59E0B" if "Medium" in conf else "#EF4444"
        
        st.markdown(f"""
        <div class="metric-card">
            <h3 style="margin: 0; font-size: 1.1rem;">Monthly Investment</h3>
            <h1 style="margin: 0.5rem 0; font-size: 2rem;">â‚¹{monthly:,.0f}</h1>
            <p style="margin: 0;">Confidence: <span style="color: {conf_color};">{conf}</span></p>
        </div>
        """, unsafe_allow_html=True)
        
        with st.expander("About this amount"):
            if monthly == 0:
                st.info("No investment recommended due to financial priorities.")
            else:
                st.info(f"""
                **How this was calculated:**
                â€¢ Based on **{investment_data['investment_percentage']:.1f}%** of available funds
                â€¢ After accounting for emergency fund building
                â€¢ After considering debt repayment needs
                â€¢ Capped at sustainable levels
                
                **This amount is:**
                â€¢ Sustainable for your income
                â€¢ Appropriate for your risk level
                â€¢ Realistic for regular investing
                """)
    
    with col2:
        annual = investment_data['annual_investment']
        st.markdown(f"""
        <div class="card" style="border-left-color: #10B981;">
            <h4 style="margin: 0;">Annual Investment</h4>
            <h2 style="margin: 0.5rem 0; color: #10B981;">â‚¹{annual:,.0f}</h2>
            <p style="margin: 0; color: #6B7280;">12 Ã— Monthly investment</p>
        </div>
        """, unsafe_allow_html=True)
        
        with st.expander("Annual perspective"):
            st.info(f"""
            **What â‚¹{annual:,.0f}/year can achieve:**
            
            Assuming 12% average annual return:
            â€¢ **5 years:** â‚¹{annual * 5:,.0f} invested, ~â‚¹{annual * 5 * 1.76:,.0f} potential value
            â€¢ **10 years:** â‚¹{annual * 10:,.0f} invested, ~â‚¹{annual * 10 * 3.11:,.0f} potential value
            â€¢ **20 years:** â‚¹{annual * 20:,.0f} invested, ~â‚¹{annual * 20 * 9.65:,.0f} potential value
            
            *Note: Returns are not guaranteed. Past performance doesn't indicate future results.*
            """)
    
    with col3:
        priority = investment_data.get('recommendation_priority', 'INVESTMENT')
        priority_colors = {
            'EMERGENCY_FUND': '#EF4444',
            'DEBT_REDUCTION': '#F59E0B',
            'INVESTMENT': '#10B981'
        }
        priority_color = priority_colors.get(priority, '#6B7280')
        
        st.markdown(f"""
        <div class="card" style="border-left-color: {priority_color};">
            <h4 style="margin: 0;">Current Priority</h4>
            <h2 style="margin: 0.5rem 0; color: {priority_color};">
                {priority.replace('_', ' ').title()}
            </h2>
            <p style="margin: 0; color: #6B7280;">Based on your assessment</p>
        </div>
        """, unsafe_allow_html=True)
        
        with st.expander("Priority explanation"):
            if priority == 'EMERGENCY_FUND':
                st.warning("""
                **Emergency Fund is Priority #1**
                
                Before any stock investing:
                1. Build emergency fund to 3-6 months of expenses
                2. This prevents selling investments during emergencies
                3. Reduces financial stress
                
                **Monthly allocation:** â‚¹{investment_data.get('monthly_ef_saving', 0):,.0f}
                """)
            elif priority == 'DEBT_REDUCTION':
                st.warning("""
                **Debt Reduction is Priority #1**
                
                Before significant stock investing:
                1. Pay down high-interest debt (>12%)
                2. This gives guaranteed "return" equal to interest rate
                3. Reduces monthly financial burden
                
                **Monthly allocation:** â‚¹{investment_data.get('monthly_debt_payment', 0):,.0f}
                """)
            else:
                st.success("""
                **Investment is Appropriate**
                
                Your financial foundation is solid:
                1. Emergency fund is adequate
                2. Debt is manageable
                3. Positive cash flow exists
                
                You can proceed with recommended investment plan.
                """)
    
    # Portfolio Allocation with explanations
    st.markdown('<h3 class="section-header">ðŸ“Š Portfolio Allocation</h3>', unsafe_allow_html=True)
    
    st.caption("""
    This allocation shows how your monthly investment should be divided across different stock categories
    to balance growth potential with appropriate risk for your profile.
    """)
    
    col1, col2 = st.columns([2, 1])
    
    with col1:
        # Prepare data for pie chart
        labels = []
        values = []
        colors_pie = []
        descriptions = []
        
        category_info = {
            "Large_Cap": ("Large Cap Stocks", "#3B82F6", "Established companies, lower risk, stable returns"),
            "Mid_Cap": ("Mid Cap Stocks", "#10B981", "Growing companies, moderate risk, good growth potential"),
            "Small_Cap": ("Small Cap Stocks", "#F59E0B", "Small companies, higher risk, high growth potential"),
            "Growth": ("Growth Stocks", "#8B5CF6", "High-growth companies, higher risk, aggressive growth"),
            "Fixed_Income": ("Fixed Income", "#6B7280", "Conservative allocation for stability")
        }
        
        for key, value in allocation.items():
            if value > 0:  # Only show categories with allocation
                label, color, desc = category_info.get(key, (key, "#999999", ""))
                labels.append(f"{label} ({value}%)")
                values.append(value)
                colors_pie.append(color)
                descriptions.append(desc)
        
        fig = go.Figure(data=[go.Pie(
            labels=labels, 
            values=values, 
            hole=0.4, 
            marker_colors=colors_pie,
            textinfo='label+percent',
            hovertemplate="<b>%{label}</b><br>%{percent}<br><i>%{customdata}</i><extra></extra>",
            customdata=descriptions
        )])
        
        fig.update_layout(
            height=400, 
            showlegend=False, 
            margin=dict(t=0, b=0, l=0, r=0),
            annotations=[dict(
                text=f"Total: 100%<br>â‚¹{investment_data['safe_monthly_investment']:,.0f}/mo",
                x=0.5, y=0.5, font_size=14, showarrow=False
            )]
        )
        st.plotly_chart(fig, use_container_width=True)
    
    with col2:
        monthly_inv = investment_data['safe_monthly_investment']
        
        with st.expander("â„¹ï¸ What do these categories mean?", expanded=True):
            st.markdown("""
            **Large Cap Stocks:**
            â€¢ Established companies (Reliance, TCS, HDFC Bank)
            â€¢ Lower risk, more stable
            â€¢ Good for conservative investors
            
            **Mid Cap Stocks:**
            â€¢ Growing companies (Titan, Asian Paints)
            â€¢ Moderate risk & growth
            â€¢ Balance of stability and growth
            
            **Small Cap Stocks:**
            â€¢ Smaller companies (Tata Elxsi, Laurus Labs)
            â€¢ Higher risk, higher potential
            â€¢ For aggressive investors
            
            **Growth Stocks:**
            â€¢ High-growth companies (DMart, Bajaj Finserv)
            â€¢ Focus on future potential
            â€¢ Higher volatility expected
            
            **Fixed Income:**
            â€¢ Conservative allocation
            â€¢ Provides stability
            â€¢ Reduces portfolio volatility
            """)
        
        st.markdown("### Allocation Breakdown")
        st.markdown("<div style='background-color:#F9FAFB; padding:1.5rem; border-radius:10px;'>", unsafe_allow_html=True)
        
        for key, value in allocation.items():
            if value > 0:
                label = category_info.get(key, (key,))[0]
                amount = (value / 100) * monthly_inv
                st.markdown(f"""
                <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #E5E7EB;">
                    <div style="display:flex; justify-content:space-between;">
                        <span style="font-weight:600;">{label}</span>
                        <span style="font-weight:600;">{value}%</span>
                    </div>
                    <div style="color:#6B7280;">â‚¹{amount:,.0f}/month</div>
                </div>
                """, unsafe_allow_html=True)
        
        st.markdown("</div>", unsafe_allow_html=True)
    
    # Stock Recommendations
    st.markdown('<h3 class="section-header">ðŸ“ˆ Stock Suggestions for Your Profile</h3>', unsafe_allow_html=True)
    
    st.caption(f"""
    Based on your **{st.session_state.risk_category}** profile and **{recommendations.get('strategy', 'Balanced')}** strategy.
    These are example stocks that match your risk profile. Always do your own research before investing.
    """)
    
    if recommendations and recommendations.get('stocks'):
        stocks = recommendations['stocks']
        
        # Create stock cards
        cols = st.columns(min(3, len(stocks)))
        
        for idx, stock in enumerate(stocks):
            with cols[idx % 3]:
                st.markdown(f"""
                <div style="background-color: white; padding: 1rem; border-radius: 8px; 
                            border-left: 4px solid #3B82F6; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 0.5rem 0;">{stock.get('symbol', '')}</h4>
                    <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #374151;">
                        {stock.get('name', '')}
                    </p>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.8rem; color: #6B7280;">{stock.get('sector', '')}</span>
                        <span style="font-size: 0.8rem; 
                                  color: {'#10B981' if stock.get('risk') == 'Low' else 
                                          '#F59E0B' if stock.get('risk') == 'Medium' else 
                                          '#EF4444'};">
                            {stock.get('risk', 'Medium')} Risk
                        </span>
                    </div>
                    <p style="font-size: 0.8rem; color: #4B5563; margin: 0;">
                        {stock.get('note', '')}
                    </p>
                </div>
                """, unsafe_allow_html=True)
    
    # ETF Recommendations if any
    if recommendations.get('etfs'):
        st.markdown("#### ETF Suggestions (for diversification)")
        etfs = recommendations['etfs']
        
        for etf in etfs:
            st.markdown(f"â€¢ **{etf}** - Exchange Traded Fund for broad market exposure")
    
    # Show calculation methodology
    show_calculation_methodology()
    
    create_navigation_buttons()


def create_action_plan_tab():
    """Create action plan with step-by-step guidance"""
    st.markdown('<h1 class="main-header">ðŸš€ Your Personalized Action Plan</h1>', unsafe_allow_html=True)
    
    if not st.session_state.assessment_complete:
        st.warning("Please complete the assessment first!")
        if st.button("Go to Assessment"):
            st.session_state.current_tab = "Assessment"
            st.rerun()
        return
    
    investment_data = st.session_state.safe_investment
    financial_data = st.session_state.financial_data
    
    # Section explanation
    show_section_explanation(
        "Your Investment Action Plan",
        "This step-by-step plan guides you from your current situation to successful stock investing. "
        "Follow these steps in order for best results.",
        [
            "Complete each step before moving to the next",
            "Timelines are realistic and achievable",
            "Focus on one priority at a time"
        ]
    )
    
    # Implementation Timeline
    st.markdown('<h3 class="section-header">ðŸ“… Step-by-Step Implementation</h3>', unsafe_allow_html=True)
    
    steps = []
    
    # Step 1: Emergency Fund (if needed)
    emergency_months = financial_data.get('emergency_months', 0)
    if emergency_months < 3:
        ef_gap = max(0, 3 - emergency_months)
        monthly_ef = investment_data.get('monthly_ef_saving', 0)
        
        if monthly_ef > 0:
            steps.append({
                "title": "Build Emergency Fund",
                "duration": f"{max(3, int(ef_gap * 3))} months",
                "action": f"Save â‚¹{monthly_ef:,.0f}/month",
                "priority": "HIGH",
                "icon": "ðŸ›¡ï¸",
                "details": f"Target: {ef_gap:.1f} months Ã— â‚¹{financial_data.get('monthly_expenses', 0):,.0f} = â‚¹{ef_gap * financial_data.get('monthly_expenses', 0):,.0f}",
                "why": "Emergency fund prevents selling investments during crises"
            })
    
    # Step 2: Debt Reduction (if needed)
    debt_score = st.session_state.answers.get('q4', 3)
    if debt_score >= 4:
        monthly_debt = investment_data.get('monthly_debt_payment', 0)
        
        if monthly_debt > 0:
            steps.append({
                "title": "Reduce High-Interest Debt",
                "duration": "6-12 months",
                "action": f"Pay â‚¹{monthly_debt:,.0f}/month extra",
                "priority": "HIGH",
                "icon": "ðŸ’³",
                "details": "Focus on debts >12% interest first",
                "why": "Debt reduction gives guaranteed returns equal to interest rate"
            })
    
    # Step 3: Start Investing (if suitable)
    suitability = investment_data.get('suitability', {}).get('suitability', 'UNKNOWN')
    if suitability in ["SUITABLE", "CAUTION ADVISED"]:
        monthly_inv = investment_data.get('safe_monthly_investment', 0)
        
        if monthly_inv > 0:
            steps.append({
                "title": "Start Stock Investing",
                "duration": "Begin immediately",
                "action": f"Invest â‚¹{monthly_inv:,.0f}/month",
                "priority": "MEDIUM",
                "icon": "ðŸ“ˆ",
                "details": f"Follow the {st.session_state.risk_category} allocation",
                "why": "Regular investing builds wealth over time"
            })
    
    # Step 4: Education (always)
    experience = st.session_state.answers.get('q11', 2)
    if experience <= 3:  # Beginner to Intermediate
        steps.append({
            "title": "Build Investing Knowledge",
            "duration": "Ongoing",
            "action": "1 hour/week learning",
            "priority": "MEDIUM",
            "icon": "ðŸ“š",
            "details": "Read books, follow markets, learn analysis",
            "why": "Knowledge prevents mistakes and improves decisions"
        })
    
    # Display steps
    for i, step in enumerate(steps):
        col1, col2, col3, col4 = st.columns([1, 3, 2, 1])
        
        with col1:
            st.markdown(f"<h2 style='margin: 0;'>{step['icon']}</h2>", unsafe_allow_html=True)
        
        with col2:
            st.markdown(f"""
            <div style="padding: 1rem;">
                <h4 style="margin: 0 0 0.5rem 0;">Step {i+1}: {step['title']}</h4>
                <p style="margin: 0; color: #4B5563; font-size: 0.9rem;">{step['action']}</p>
                <p style="margin: 0.25rem 0 0 0; color: #6B7280; font-size: 0.8rem;">{step['details']}</p>
            </div>
            """, unsafe_allow_html=True)
        
        with col3:
            st.markdown(f"""
            <div style="padding: 1rem; background-color: #F3F4F6; border-radius: 8px;">
                <p style="margin: 0; color: #6B7280; font-weight: 600;">Timeline</p>
                <p style="margin: 0.25rem 0 0 0; font-weight: 600;">{step['duration']}</p>
            </div>
            """, unsafe_allow_html=True)
        
        with col4:
            priority_color = "#EF4444" if step['priority'] == "HIGH" else "#F59E0B" if step['priority'] == "MEDIUM" else "#10B981"
            st.markdown(f"""
            <div style="padding: 1rem; background-color: {priority_color}10; border-radius: 8px;">
                <p style="margin: 0; color: {priority_color}; font-weight: 600;">{step['priority']}</p>
            </div>
            """, unsafe_allow_html=True)
        
        # Why this step matters
        with st.expander(f"Why Step {i+1} matters"):
            st.info(step['why'])
        
        st.markdown("---")
    
    # Next Steps Guidance
    st.markdown('<h3 class="section-header">ðŸ”® Next Steps After Implementation</h3>', unsafe_allow_html=True)
    
    next_steps = [
        ("Review Quarterly", "Check progress every 3 months. Adjust if circumstances change."),
        ("Rebalance Annually", "Bring portfolio back to target allocation once per year."),
        ("Increase Gradually", "Raise investment amount with salary increases."),
        ("Stay Educated", "Continue learning about markets and investing."),
        ("Avoid Panic", "Don't make emotional decisions during market declines.")
    ]
    
    for title, description in next_steps:
        st.markdown(f"**{title}:** {description}")
    
    # Export Section
    st.markdown('<h3 class="section-header">ðŸ“„ Export Your Complete Plan</h3>', unsafe_allow_html=True)
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        assessment_data = {
            'answers': st.session_state.answers,
            'financial_data': st.session_state.financial_data,
            'risk_data': st.session_state.risk_data,
            'risk_category': st.session_state.risk_category,
            'allocation': st.session_state.allocation,
            'investment_data': st.session_state.safe_investment,
            'recommendations': st.session_state.recommendations
        }
        
        pdf = AssessmentPDF(assessment_data)
        pdf_buffer = pdf.generate_pdf()
        
        st.download_button(
            label="ðŸ“¥ Download PDF Report",
            data=pdf_buffer.getvalue(),
            file_name=f"Stock_Risk_Advisor_{st.session_state.assessment_id}.pdf",
            mime="application/pdf",
            use_container_width=True,
            help="Complete assessment report with all recommendations"
        )
    
    with col2:
        if os.path.exists(CSV_FILE):
            with open(CSV_FILE, 'r', encoding='utf-8') as f:
                csv_data = f.read()
            
            st.download_button(
                label="ðŸ“Š Download All Data CSV",
                data=csv_data,
                file_name="all_assessments.csv",
                mime="text/csv",
                use_container_width=True,
                help="All assessments data for your research"
            )
    
    with col3:
        assessment_json = json.dumps({
            'assessment_id': st.session_state.assessment_id,
            'timestamp': datetime.now().isoformat(),
            'model_version': MODEL_VERSION,
            'answers': st.session_state.answers,
            'financial_data': st.session_state.financial_data,
            'risk_data': st.session_state.risk_data,
            'risk_category': st.session_state.risk_category,
            'safe_investment': st.session_state.safe_investment,
            'allocation': st.session_state.allocation,
            'recommendations': st.session_state.recommendations
        }, indent=2, default=str)
        
        st.download_button(
            label="ðŸ“ Download JSON Report",
            data=assessment_json,
            file_name=f"assessment_{st.session_state.assessment_id}.json",
            mime="application/json",
            use_container_width=True,
            help="Structured data for analysis or integration"
        )
    
    create_navigation_buttons()


def create_data_export_tab():
    """Create data export and analysis tab"""
    st.markdown('<h1 class="main-header">ðŸ“Š Data Management & Research Export</h1>', unsafe_allow_html=True)
    
    df = CSVDataHandler.load_assessments_from_csv()
    
    if df.empty:
        st.info("No assessment data available yet. Complete an assessment to see data here.")
        if st.button("Go to Assessment"):
            st.session_state.current_tab = "Assessment"
            st.rerun()
        return
    
    # Section explanation
    show_section_explanation(
        "Assessment Data & Research Export",
        "This section shows aggregated assessment data and allows export for research purposes. "
        "All data is anonymized and stored locally.",
        [
            "Data includes financial metrics, risk scores, and recommendations",
            "Useful for tracking trends and research analysis",
            "Export formats: CSV, JSON, and visual charts"
        ]
    )
    
    # Statistics with model version filter
    st.markdown('<h3 class="section-header">ðŸ“ˆ Assessment Statistics</h3>', unsafe_allow_html=True)
    
    # Filter by model version if available
    if 'model_version' in df.columns:
        current_version_df = df[df['model_version'] == MODEL_VERSION]
        other_version_df = df[df['model_version'] != MODEL_VERSION]
        
        if not current_version_df.empty:
            st.success(f"**Current Model ({MODEL_VERSION}):** {len(current_version_df)} assessments")
            df = current_version_df
        elif not other_version_df.empty:
            st.warning(f"**Note:** Data from older model versions. Current: {MODEL_VERSION}")
            df = other_version_df
    
    # Check required columns
    required_cols = ['financial_health_score', 'overall_risk_score']
    missing_cols = [col for col in required_cols if col not in df.columns]
    
    if missing_cols:
        st.warning(f"Data format issue. Missing columns: {', '.join(missing_cols)}")
        st.info("This may be data from an older version. New assessments will have proper format.")
    else:
        # Clean data
        clean_df = df.dropna(subset=required_cols, how='any')
        
        if not clean_df.empty:
            col1, col2, col3, col4 = st.columns(4)
            with col1:
                total = len(clean_df)
                st.metric("Total Assessments", total)
            
            with col2:
                avg_fh = clean_df['financial_health_score'].mean()
                st.metric("Avg Financial Health", f"{avg_fh:.1f}" if not pd.isna(avg_fh) else "N/A")
            
            with col3:
                if 'monthly_investment' in clean_df.columns:
                    avg_inv = clean_df['monthly_investment'].mean()
                    st.metric("Avg Monthly Investment", f"â‚¹{avg_inv:,.0f}" if not pd.isna(avg_inv) else "â‚¹0")
            
            with col4:
                if 'risk_category' in clean_df.columns:
                    most_common = clean_df['risk_category'].mode()
                    if not most_common.empty:
                        st.metric("Most Common Risk", most_common.iloc[0])
    
    # Visualizations
    st.markdown('<h3 class="section-header">ðŸ“Š Data Visualizations</h3>', unsafe_allow_html=True)
    
    if not df.empty and 'overall_risk_score' in df.columns and 'financial_health_score' in df.columns:
        col1, col2 = st.columns(2)
        
        with col1:
            # Risk Score Distribution
            fig1 = px.histogram(
                df, x='overall_risk_score',
                nbins=20,
                title='Distribution of Risk Scores',
                labels={'overall_risk_score': 'Risk Score'},
                color_discrete_sequence=['#3B82F6']
            )
            fig1.update_layout(height=300, margin=dict(t=40, b=20, l=20, r=20))
            st.plotly_chart(fig1, use_container_width=True)
        
        with col2:
            # Financial Health vs Risk Score
            fig2 = px.scatter(
                df, x='financial_health_score', y='overall_risk_score',
                title='Financial Health vs Risk Score',
                labels={'financial_health_score': 'Financial Health', 'overall_risk_score': 'Risk Score'},
                color_discrete_sequence=['#10B981']
            )
            fig2.update_layout(height=300, margin=dict(t=40, b=20, l=20, r=20))
            st.plotly_chart(fig2, use_container_width=True)
    
    # Recent Assessments
    st.markdown('<h3 class="section-header">ðŸ“‹ Recent Assessments</h3>', unsafe_allow_html=True)
    
    if 'timestamp' in df.columns:
        recent_df = df.head(10).copy()
        
        # Format display columns
        display_cols = ['timestamp']
        
        # Add available columns
        available_cols = ['financial_health_score', 'risk_category', 'monthly_investment', 
                         'overall_risk_score', 'model_version']
        
        for col in available_cols:
            if col in recent_df.columns:
                display_cols.append(col)
        
        display_df = recent_df[display_cols].copy()
        
        # Format timestamp
        if 'timestamp' in display_df.columns:
            display_df['timestamp'] = display_df['timestamp'].dt.strftime('%Y-%m-%d %H:%M')
        
        # Format monthly investment
        if 'monthly_investment' in display_df.columns:
            display_df['monthly_investment'] = display_df['monthly_investment'].apply(
                lambda x: f"â‚¹{x:,.0f}" if not pd.isna(x) and x > 0 else "â‚¹0"
            )
        
        # Format scores
        score_cols = ['financial_health_score', 'overall_risk_score']
        for col in score_cols:
            if col in display_df.columns:
                display_df[col] = display_df[col].apply(
                    lambda x: f"{x:.1f}" if not pd.isna(x) else "N/A"
                )
        
        st.dataframe(display_df, use_container_width=True, hide_index=True)
    
    # Export Options with explanations
    st.markdown('<h3 class="section-header">ðŸ“ Export Options</h3>', unsafe_allow_html=True)
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        csv_data = df.to_csv(index=False)
        st.download_button(
            label="ðŸ“Š Download Full CSV",
            data=csv_data,
            file_name=f"stock_risk_assessments_{datetime.now().strftime('%Y%m%d')}.csv",
            mime="text/csv",
            use_container_width=True,
            help="Complete dataset in CSV format for analysis"
        )
    
    with col2:
        # JSON export
        json_data = df.to_json(orient='records', indent=2)
        st.download_button(
            label="ðŸ“ Download JSON Data",
            data=json_data,
            file_name=f"assessments_{datetime.now().strftime('%Y%m%d')}.json",
            mime="application/json",
            use_container_width=True,
            help="Structured JSON data for programmatic analysis"
        )
    
    with col3:
        if st.button("ðŸ—‘ï¸ Clear All Data", type="secondary", use_container_width=True):
            st.warning("### âš ï¸ Delete All Assessment Data")
            st.markdown("This will permanently delete all stored assessment data. This action cannot be undone.")
            
            col_yes, col_no = st.columns(2)
            with col_yes:
                if st.button("Yes, Delete All Data", type="primary"):
                    try:
                        if os.path.exists(CSV_FILE):
                            os.remove(CSV_FILE)
                            st.success("âœ… All data cleared successfully!")
                            st.rerun()
                        else:
                            st.info("No data file found.")
                    except Exception as e:
                        st.error(f"Error clearing data: {str(e)}")
            with col_no:
                if st.button("Cancel", type="secondary"):
                    st.rerun()
    
    # Research Notes
    with st.expander("ðŸ”¬ Research & Academic Use Notes"):
        st.markdown(f"""
        ### For Research & Academic Purposes
        
        **Dataset Description:**
        - **Variables:** 30+ variables including demographics, financial metrics, risk scores, recommendations
        - **Sample:** {len(df)} assessments (as of {datetime.now().strftime('%Y-%m-%d')})
        - **Model:** Version {MODEL_VERSION}
        
        **Key Variables for Analysis:**
        1. **Demographics:** Age group, income, expenses
        2. **Financial Metrics:** Savings rate, emergency fund, debt status
        3. **Psychological Factors:** Risk tolerance, emotional responses
        4. **Investment Factors:** Time horizon, goals, experience
        5. **Outcomes:** Risk category, recommended allocation, investment amount
        
        **Research Applications:**
        - Behavioral finance studies
        - Risk profiling algorithms
        - Financial literacy assessment
        - Investment recommendation systems
        
        **Ethical Considerations:**
        - Data is anonymized
        - Educational purpose only
        - Not financial advice
        - Local storage only
        
        **Citation Suggestion:**
        > Stock Risk Advisor Assessment Data. Model Version {MODEL_VERSION}. 
        > [Your Institution], {datetime.now().strftime('%Y')}.
        """)
    
    create_navigation_buttons()


def create_welcome_tab():
    """Create welcome tab with enhanced explanations"""
    st.markdown('<h1 class="main-header">ðŸ“ˆ Welcome to Stock Risk Advisor v2.1!</h1>', unsafe_allow_html=True)
    
    col1, col2 = st.columns([2, 1])
    
    with col1:
        st.markdown("""
        ## Your Intelligent Stock Investment Guide
        
        **Stock Risk Advisor helps you make informed, personalized stock investment decisions**
        based on your complete financial profile and risk tolerance.
        
        ### ðŸŽ¯ What Makes This Tool Different?
        
        âœ… **Comprehensive Assessment** - 14 questions across 4 key dimensions  
        âœ… **Transparent Methodology** - See exactly how recommendations are calculated  
        âœ… **Financial Health First** - Checks emergency fund & debt before investing  
        âœ… **Personalized Recommendations** - Stocks and allocation matching YOUR profile  
        âœ… **Research-Ready** - Export data for academic or personal analysis  
        âœ… **Educational Focus** - Learn about investing while getting recommendations  
        
        ### ðŸ“‹ What You'll Get
        
        1. **Financial Health Score** - How ready you are to invest  
        2. **Risk Profile** - Your personalized risk category  
        3. **Portfolio Allocation** - Large/Mid/Small cap percentages  
        4. **Specific Stock Suggestions** - Examples matching your profile  
        5. **Safe Investment Amount** - Sustainable monthly investment  
        6. **Action Plan** - Step-by-step implementation guide  
        7. **Export Options** - PDF, CSV, JSON reports  
        
        ### â±ï¸ Time Required
        **8-10 minutes** for 14 comprehensive questions
        
        ### ðŸ”’ Privacy & Data
        â€¢ All data stored locally on your device  
        â€¢ No registration or personal information required  
        â€¢ Export and delete data anytime  
        â€¢ Educational purpose only - not financial advice  
        """)
    
    with col2:
        st.image("https://img.icons8.com/color/300/000000/stock-exchange.png", width=250)
        
        # Quick stats if available
        try:
            stats = CSVDataHandler.get_statistics()
            if stats and stats['total_assessments'] > 0:
                st.markdown("---")
                st.markdown("### ðŸ“Š Community Stats")
                st.metric("Total Assessments", stats['total_assessments'])
                st.metric("Avg Financial Health", f"{stats['avg_financial_health']:.1f}")
                st.metric("Most Common Risk", stats['most_common_risk_category'])
        except:
            pass
    
    st.markdown("---")
    
    # Start button
    col1, col2, col3 = st.columns([1, 2, 1])
    with col2:
        if st.button("â–¶ï¸ Begin Comprehensive Assessment", type="primary", use_container_width=True, key="start_assessment"):
            st.session_state.current_tab = "Assessment"
            st.rerun()
    
    st.markdown("---")
    
    # Assessment Overview
    st.markdown("""
    ### ðŸ“‹ Assessment Overview
    
    #### Part 1: Financial Foundation (4 questions)
    - Income, expenses, emergency fund, debt situation
    - **Purpose:** Check if you're financially ready to invest
    
    #### Part 2: Goals & Timeframe (3 questions)
    - Investment purpose, timeline, loss importance
    - **Purpose:** Match strategy to your objectives
    
    #### Part 3: Risk Psychology (3 questions)
    - Emotional reactions, loss tolerance, volatility view
    - **Purpose:** Understand your true risk tolerance
    
    #### Part 4: Experience & Personal (4 questions)
    - Knowledge, experience, liquidity needs, age
    - **Purpose:** Customize recommendations to your situation
    """)
    
    # Methodology Preview
    with st.expander("ðŸ”¬ Preview: How We Calculate Recommendations"):
        st.markdown(f"""
        ### Transparent Assessment Methodology (v{MODEL_VERSION})
        
        Your recommendations are calculated using a **weighted multi-dimensional model**:
        
        **1. Financial Stability (30%)**
        - Emergency Fund: 40%
        - Debt Situation: 35%
        - Savings Rate: 25%
        
        **2. Risk Tolerance (30%)**
        - Loss Importance: 30%
        - Emotional Reaction: 25%
        - Loss Tolerance: 30%
        - Volatility View: 15%
        
        **3. Investment Horizon (20%)**
        - Primary Goal: 40%
        - Timeframe: 40%
        - Liquidity Needs: 20%
        
        **4. Knowledge & Experience (20%)**
        - Experience: 60%
        - Knowledge: 40%
        
        **Plus:**
        â€¢ Age-appropriate allocation (younger = more equity)
        â€¢ Suitability checks before recommendations
        â€¢ Sustainable investment amount calculation
        
        **Model Features:**
        âœ… No double-counting of factors  
        âœ… Realistic Indian income/expense ranges  
        âœ… Emergency fund & debt priority checks  
        âœ… Transparent weighting system  
        âœ… Research-quality data collection  
        """)
    
    # Disclaimer
    st.markdown("""
    ---
    <div style='text-align:center; color:#6B7280; font-size:0.9rem; padding:1rem 0;'>
        <p>âš ï¸ <strong>Educational Purpose Only</strong> - This tool helps understand stock investing principles.</p>
        <p>We are not SEBI-registered investment advisors. This is not financial advice.</p>
        <p>Investing in stocks involves risk of loss. Past performance doesn't guarantee future results.</p>
        <p>Model Version: {MODEL_VERSION} | Data stored locally in CSV format</p>
    </div>
    """.format(MODEL_VERSION=MODEL_VERSION), unsafe_allow_html=True)


# ============================================================================
# MAIN APP
# ============================================================================

def main():
    """Main application function"""
    
    # Sidebar with enhanced information
    with st.sidebar:
        st.image("https://img.icons8.com/color/96/000000/stock-exchange.png", width=80)
        st.title("Stock Risk Advisor")
        st.caption(f"Model v{MODEL_VERSION}")
        st.markdown("---")
        
        # Navigation
        st.subheader("ðŸ“Š Navigation")
        tabs = ["Welcome", "Assessment", "Financial Health", "Risk Profile", 
                "Recommendations", "Action Plan", "Data & Export"]
        
        for tab in tabs:
            if st.button(f"ðŸ“ {tab}", use_container_width=True, 
                        help=f"Go to {tab} section"):
                st.session_state.current_tab = tab
                st.rerun()
        
        st.markdown("---")
        
        # Assessment Status
        if st.session_state.assessment_complete:
            st.success("âœ… Assessment Complete")
            
            col1, col2 = st.columns(2)
            with col1:
                if st.button("ðŸ”„ New", help="Start new assessment", use_container_width=True):
                    for key in list(st.session_state.keys()):
                        del st.session_state[key]
                    init_session_state()
                    st.rerun()
            with col2:
                if st.button("ðŸ“Š Results", help="View results", use_container_width=True):
                    st.session_state.current_tab = "Financial Health"
                    st.rerun()
        else:
            st.info("ðŸ“‹ Complete assessment to see results")
            if st.button("Start Assessment", use_container_width=True):
                st.session_state.current_tab = "Assessment"
                st.rerun()
        
        st.markdown("---")
        
        # Statistics with enhanced display
        try:
            stats = CSVDataHandler.get_statistics()
            if stats and stats['total_assessments'] > 0:
                with st.expander("ðŸ“ˆ Overall Statistics", expanded=False):
                    st.metric("Total Assessments", stats['total_assessments'])
                    st.metric("Model Version", stats.get('model_version', MODEL_VERSION))
                    st.metric("Avg Financial Health", f"{stats['avg_financial_health']:.1f}")
                    st.metric("Avg Risk Score", f"{stats.get('avg_risk_score', 0):.1f}")
                    st.metric("Most Common Risk", stats['most_common_risk_category'])
                    st.metric("Avg Monthly Investment", f"â‚¹{stats['avg_monthly_investment']:,.0f}")
        except:
            pass
        
        st.markdown("---")
        
        # About Section with detailed information
        with st.expander("â„¹ï¸ About This Tool", expanded=False):
            st.markdown(f"""
            ### Stock Risk Advisor v{MODEL_VERSION}
            
            **Purpose:**
            Educational tool for understanding stock investment risk assessment.
            
            **Methodology:**
            1. 14-question multi-dimensional assessment
            2. Four assessment dimensions
            3. Transparent scoring system
            4. Age-appropriate recommendations
            
            **Key Features:**
            âœ… Financial health assessment first
            âœ… Risk profiling without double-counting
            âœ… Suitability checks
            âœ… Personalized stock suggestions
            âœ… Sustainable investment amounts
            âœ… Export options (PDF, CSV, JSON)
            âœ… Research-quality data collection
            
            **Assessment Parts:**
            1. **Financial Foundation** (4 questions)
            2. **Goals & Timeframe** (3 questions)
            3. **Risk Psychology** (3 questions)
            4. **Experience & Personal** (4 questions)
            
            **Data & Privacy:**
            â€¢ All data stored locally
            â€¢ No personal identification collected
            â€¢ Export/delete anytime
            â€¢ Educational use only
            
            **âš ï¸ Important Notice:**
            We are not SEBI-registered investment advisors.
            This is **not financial advice**.
            Investing involves risk of loss.
            
            **For Research:**
            â€¢ Transparent methodology
            â€¢ Exportable data
            â€¢ Version tracking
            â€¢ Academic applications
            """)
    
    # Main content
    create_progress_bar()
    
    # Route to correct tab
    tab_functions = {
        "Welcome": create_welcome_tab,
        "Assessment": create_assessment_tab,
        "Financial Health": create_financial_health_tab,
        "Risk Profile": create_risk_profile_tab,
        "Recommendations": create_recommendations_tab,
        "Action Plan": create_action_plan_tab,
        "Data & Export": create_data_export_tab
    }
    
    current_tab = st.session_state.current_tab
    if current_tab in tab_functions:
        tab_functions[current_tab]()
    
    # Enhanced Footer
    st.markdown("---")
    st.markdown(f"""
    <div style='text-align:center; color:#6B7280; font-size:0.9rem; padding:1rem 0;'>
        <p>âš ï¸ <strong>Educational Purpose Only</strong> - This tool helps understand stock investing based on risk profiles.</p>
        <p>We are not SEBI-registered investment advisors. This is not financial advice.</p>
        <p>Investing in stocks involves risk of loss. Past performance doesn't guarantee future results.</p>
        <p>Data is stored locally in CSV format for analysis and export. Model Version: {MODEL_VERSION}</p>
        <p style='font-size:0.8rem; margin-top:1rem;'>
            Icons by <a href='https://icons8.com' target='_blank'>Icons8</a> | 
            Built with <a href='https://streamlit.io' target='_blank'>Streamlit</a>
        </p>
    </div>
    """, unsafe_allow_html=True)


if __name__ == "__main__":
    main()
